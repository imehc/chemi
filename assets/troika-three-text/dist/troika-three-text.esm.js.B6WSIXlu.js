import{T as Ot,L as lt,bo as It,o as Bt,m as Rt,ay as Mt,y as Ut,bk as Et,A as qe,aD as ft,q as nt,bp as Pt,M as ot,az as Lt,P as at,K as Wt,a8 as zt,g as Nt,n as Vt,V as it}from"../../three/build/three.module.js.CElijN_X.js";import{d as Pe,t as jt}from"../../troika-worker-utils/dist/troika-worker-utils.esm.js.M_FGPiF4.js";import{S as xt}from"../../webgl-sdf-generator/dist/webgl-sdf-generator.mjs.B9WjZ7l-.js";import{b as Ht}from"../../bidi-js/dist/bidi.mjs.Dpu9EnKw.js";import{c as Xt,v as qt}from"../../troika-three-utils/dist/troika-three-utils.esm.js.DYAmDGB0.js";/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/function $t(){return typeof window>"u"&&(self.window=self),function(v){var a={parse:function(t){var e=a._bin,n=new Uint8Array(t);if(e.readASCII(n,0,4)=="ttcf"){var o=4;e.readUshort(n,o),o+=2,e.readUshort(n,o),o+=2;var r=e.readUint(n,o);o+=4;for(var i=[],s=0;s<r;s++){var l=e.readUint(n,o);o+=4,i.push(a._readFont(n,l))}return i}return[a._readFont(n,0)]},_readFont:function(t,e){var n=a._bin,o=e;n.readFixed(t,e),e+=4;var r=n.readUshort(t,e);e+=2,n.readUshort(t,e),e+=2,n.readUshort(t,e),e+=2,n.readUshort(t,e),e+=2;for(var i=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],s={_data:t,_offset:o},l={},f=0;f<r;f++){var u=n.readASCII(t,e,4);e+=4,n.readUint(t,e),e+=4;var c=n.readUint(t,e);e+=4;var g=n.readUint(t,e);e+=4,l[u]={offset:c,length:g}}for(f=0;f<i.length;f++){var y=i[f];l[y]&&(s[y.trim()]=a[y.trim()].parse(t,l[y].offset,l[y].length,s))}return s},_tabOffset:function(t,e,n){for(var o=a._bin,r=o.readUshort(t,n+4),i=n+12,s=0;s<r;s++){var l=o.readASCII(t,i,4);i+=4,o.readUint(t,i),i+=4;var f=o.readUint(t,i);if(i+=4,o.readUint(t,i),i+=4,l==e)return f}return 0}};a._bin={readFixed:function(t,e){return(t[e]<<8|t[e+1])+(t[e+2]<<8|t[e+3])/65540},readF2dot14:function(t,e){return a._bin.readShort(t,e)/16384},readInt:function(t,e){return a._bin._view(t).getInt32(e)},readInt8:function(t,e){return a._bin._view(t).getInt8(e)},readShort:function(t,e){return a._bin._view(t).getInt16(e)},readUshort:function(t,e){return a._bin._view(t).getUint16(e)},readUshorts:function(t,e,n){for(var o=[],r=0;r<n;r++)o.push(a._bin.readUshort(t,e+2*r));return o},readUint:function(t,e){return a._bin._view(t).getUint32(e)},readUint64:function(t,e){return 4294967296*a._bin.readUint(t,e)+a._bin.readUint(t,e+4)},readASCII:function(t,e,n){for(var o="",r=0;r<n;r++)o+=String.fromCharCode(t[e+r]);return o},readUnicode:function(t,e,n){for(var o="",r=0;r<n;r++){var i=t[e++]<<8|t[e++];o+=String.fromCharCode(i)}return o},_tdec:typeof window<"u"&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(t,e,n){var o=a._bin._tdec;return o&&e==0&&n==t.length?o.decode(t):a._bin.readASCII(t,e,n)},readBytes:function(t,e,n){for(var o=[],r=0;r<n;r++)o.push(t[e+r]);return o},readASCIIArray:function(t,e,n){for(var o=[],r=0;r<n;r++)o.push(String.fromCharCode(t[e+r]));return o},_view:function(t){return t._dataView||(t._dataView=t.buffer?new DataView(t.buffer,t.byteOffset,t.byteLength):new DataView(new Uint8Array(t).buffer))}},a._lctf={},a._lctf.parse=function(t,e,n,o,r){var i=a._bin,s={},l=e;i.readFixed(t,e),e+=4;var f=i.readUshort(t,e);e+=2;var u=i.readUshort(t,e);e+=2;var c=i.readUshort(t,e);return e+=2,s.scriptList=a._lctf.readScriptList(t,l+f),s.featureList=a._lctf.readFeatureList(t,l+u),s.lookupList=a._lctf.readLookupList(t,l+c,r),s},a._lctf.readLookupList=function(t,e,n){var o=a._bin,r=e,i=[],s=o.readUshort(t,e);e+=2;for(var l=0;l<s;l++){var f=o.readUshort(t,e);e+=2;var u=a._lctf.readLookupTable(t,r+f,n);i.push(u)}return i},a._lctf.readLookupTable=function(t,e,n){var o=a._bin,r=e,i={tabs:[]};i.ltype=o.readUshort(t,e),e+=2,i.flag=o.readUshort(t,e),e+=2;var s=o.readUshort(t,e);e+=2;for(var l=i.ltype,f=0;f<s;f++){var u=o.readUshort(t,e);e+=2;var c=n(t,l,r+u,i);i.tabs.push(c)}return i},a._lctf.numOfOnes=function(t){for(var e=0,n=0;n<32;n++)t>>>n&1&&e++;return e},a._lctf.readClassDef=function(t,e){var n=a._bin,o=[],r=n.readUshort(t,e);if(e+=2,r==1){var i=n.readUshort(t,e);e+=2;var s=n.readUshort(t,e);e+=2;for(var l=0;l<s;l++)o.push(i+l),o.push(i+l),o.push(n.readUshort(t,e)),e+=2}if(r==2){var f=n.readUshort(t,e);for(e+=2,l=0;l<f;l++)o.push(n.readUshort(t,e)),e+=2,o.push(n.readUshort(t,e)),e+=2,o.push(n.readUshort(t,e)),e+=2}return o},a._lctf.getInterval=function(t,e){for(var n=0;n<t.length;n+=3){var o=t[n],r=t[n+1];if(t[n+2],o<=e&&e<=r)return n}return-1},a._lctf.readCoverage=function(t,e){var n=a._bin,o={};o.fmt=n.readUshort(t,e),e+=2;var r=n.readUshort(t,e);return e+=2,o.fmt==1&&(o.tab=n.readUshorts(t,e,r)),o.fmt==2&&(o.tab=n.readUshorts(t,e,3*r)),o},a._lctf.coverageIndex=function(t,e){var n=t.tab;if(t.fmt==1)return n.indexOf(e);if(t.fmt==2){var o=a._lctf.getInterval(n,e);if(o!=-1)return n[o+2]+(e-n[o])}return-1},a._lctf.readFeatureList=function(t,e){var n=a._bin,o=e,r=[],i=n.readUshort(t,e);e+=2;for(var s=0;s<i;s++){var l=n.readASCII(t,e,4);e+=4;var f=n.readUshort(t,e);e+=2;var u=a._lctf.readFeatureTable(t,o+f);u.tag=l.trim(),r.push(u)}return r},a._lctf.readFeatureTable=function(t,e){var n=a._bin,o=e,r={},i=n.readUshort(t,e);e+=2,i>0&&(r.featureParams=o+i);var s=n.readUshort(t,e);e+=2,r.tab=[];for(var l=0;l<s;l++)r.tab.push(n.readUshort(t,e+2*l));return r},a._lctf.readScriptList=function(t,e){var n=a._bin,o=e,r={},i=n.readUshort(t,e);e+=2;for(var s=0;s<i;s++){var l=n.readASCII(t,e,4);e+=4;var f=n.readUshort(t,e);e+=2,r[l.trim()]=a._lctf.readScriptTable(t,o+f)}return r},a._lctf.readScriptTable=function(t,e){var n=a._bin,o=e,r={},i=n.readUshort(t,e);e+=2,i>0&&(r.default=a._lctf.readLangSysTable(t,o+i));var s=n.readUshort(t,e);e+=2;for(var l=0;l<s;l++){var f=n.readASCII(t,e,4);e+=4;var u=n.readUshort(t,e);e+=2,r[f.trim()]=a._lctf.readLangSysTable(t,o+u)}return r},a._lctf.readLangSysTable=function(t,e){var n=a._bin,o={};n.readUshort(t,e),e+=2,o.reqFeature=n.readUshort(t,e),e+=2;var r=n.readUshort(t,e);return e+=2,o.features=n.readUshorts(t,e,r),o},a.CFF={},a.CFF.parse=function(t,e,n){var o=a._bin;(t=new Uint8Array(t.buffer,e,n))[e=0],t[++e],t[++e],t[++e],e++;var r=[];e=a.CFF.readIndex(t,e,r);for(var i=[],s=0;s<r.length-1;s++)i.push(o.readASCII(t,e+r[s],r[s+1]-r[s]));e+=r[r.length-1];var l=[];e=a.CFF.readIndex(t,e,l);var f=[];for(s=0;s<l.length-1;s++)f.push(a.CFF.readDict(t,e+l[s],e+l[s+1]));e+=l[l.length-1];var u=f[0],c=[];e=a.CFF.readIndex(t,e,c);var g=[];for(s=0;s<c.length-1;s++)g.push(o.readASCII(t,e+c[s],c[s+1]-c[s]));if(e+=c[c.length-1],a.CFF.readSubrs(t,e,u),u.CharStrings){e=u.CharStrings,c=[],e=a.CFF.readIndex(t,e,c);var y=[];for(s=0;s<c.length-1;s++)y.push(o.readBytes(t,e+c[s],c[s+1]-c[s]));u.CharStrings=y}if(u.ROS){e=u.FDArray;var _=[];for(e=a.CFF.readIndex(t,e,_),u.FDArray=[],s=0;s<_.length-1;s++){var b=a.CFF.readDict(t,e+_[s],e+_[s+1]);a.CFF._readFDict(t,b,g),u.FDArray.push(b)}e+=_[_.length-1],e=u.FDSelect,u.FDSelect=[];var U=t[e];if(e++,U!=3)throw U;var m=o.readUshort(t,e);for(e+=2,s=0;s<m+1;s++)u.FDSelect.push(o.readUshort(t,e),t[e+2]),e+=3}return u.Encoding&&(u.Encoding=a.CFF.readEncoding(t,u.Encoding,u.CharStrings.length)),u.charset&&(u.charset=a.CFF.readCharset(t,u.charset,u.CharStrings.length)),a.CFF._readFDict(t,u,g),u},a.CFF._readFDict=function(t,e,n){var o;for(var r in e.Private&&(o=e.Private[1],e.Private=a.CFF.readDict(t,o,o+e.Private[0]),e.Private.Subrs&&a.CFF.readSubrs(t,o+e.Private.Subrs,e.Private)),e)["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(r)!=-1&&(e[r]=n[e[r]-426+35])},a.CFF.readSubrs=function(t,e,n){var o=a._bin,r=[];e=a.CFF.readIndex(t,e,r);var i,s=r.length;i=s<1240?107:s<33900?1131:32768,n.Bias=i,n.Subrs=[];for(var l=0;l<r.length-1;l++)n.Subrs.push(o.readBytes(t,e+r[l],r[l+1]-r[l]))},a.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],a.CFF.glyphByUnicode=function(t,e){for(var n=0;n<t.charset.length;n++)if(t.charset[n]==e)return n;return-1},a.CFF.glyphBySE=function(t,e){return e<0||e>255?-1:a.CFF.glyphByUnicode(t,a.CFF.tableSE[e])},a.CFF.readEncoding=function(t,e,n){a._bin;var o=[".notdef"],r=t[e];if(e++,r!=0)throw"error: unknown encoding format: "+r;var i=t[e];e++;for(var s=0;s<i;s++)o.push(t[e+s]);return o},a.CFF.readCharset=function(t,e,n){var o=a._bin,r=[".notdef"],i=t[e];if(e++,i==0)for(var s=0;s<n;s++){var l=o.readUshort(t,e);e+=2,r.push(l)}else{if(i!=1&&i!=2)throw"error: format: "+i;for(;r.length<n;){l=o.readUshort(t,e),e+=2;var f=0;for(i==1?(f=t[e],e++):(f=o.readUshort(t,e),e+=2),s=0;s<=f;s++)r.push(l),l++}}return r},a.CFF.readIndex=function(t,e,n){var o=a._bin,r=o.readUshort(t,e)+1,i=t[e+=2];if(e++,i==1)for(var s=0;s<r;s++)n.push(t[e+s]);else if(i==2)for(s=0;s<r;s++)n.push(o.readUshort(t,e+2*s));else if(i==3)for(s=0;s<r;s++)n.push(16777215&o.readUint(t,e+3*s-1));else if(r!=1)throw"unsupported offset size: "+i+", count: "+r;return(e+=r*i)-1},a.CFF.getCharString=function(t,e,n){var o=a._bin,r=t[e],i=t[e+1];t[e+2],t[e+3],t[e+4];var s=1,l=null,f=null;r<=20&&(l=r,s=1),r==12&&(l=100*r+i,s=2),21<=r&&r<=27&&(l=r,s=1),r==28&&(f=o.readShort(t,e+1),s=3),29<=r&&r<=31&&(l=r,s=1),32<=r&&r<=246&&(f=r-139,s=1),247<=r&&r<=250&&(f=256*(r-247)+i+108,s=2),251<=r&&r<=254&&(f=256*-(r-251)-i-108,s=2),r==255&&(f=o.readInt(t,e+1)/65535,s=5),n.val=f??"o"+l,n.size=s},a.CFF.readCharString=function(t,e,n){for(var o=e+n,r=a._bin,i=[];e<o;){var s=t[e],l=t[e+1];t[e+2],t[e+3],t[e+4];var f=1,u=null,c=null;s<=20&&(u=s,f=1),s==12&&(u=100*s+l,f=2),s!=19&&s!=20||(u=s,f=2),21<=s&&s<=27&&(u=s,f=1),s==28&&(c=r.readShort(t,e+1),f=3),29<=s&&s<=31&&(u=s,f=1),32<=s&&s<=246&&(c=s-139,f=1),247<=s&&s<=250&&(c=256*(s-247)+l+108,f=2),251<=s&&s<=254&&(c=256*-(s-251)-l-108,f=2),s==255&&(c=r.readInt(t,e+1)/65535,f=5),i.push(c??"o"+u),e+=f}return i},a.CFF.readDict=function(t,e,n){for(var o=a._bin,r={},i=[];e<n;){var s=t[e],l=t[e+1];t[e+2],t[e+3],t[e+4];var f=1,u=null,c=null;if(s==28&&(c=o.readShort(t,e+1),f=3),s==29&&(c=o.readInt(t,e+1),f=5),32<=s&&s<=246&&(c=s-139,f=1),247<=s&&s<=250&&(c=256*(s-247)+l+108,f=2),251<=s&&s<=254&&(c=256*-(s-251)-l-108,f=2),s==255)throw c=o.readInt(t,e+1)/65535,f=5,"unknown number";if(s==30){var g=[];for(f=1;;){var y=t[e+f];f++;var _=y>>4,b=15&y;if(_!=15&&g.push(_),b!=15&&g.push(b),b==15)break}for(var U="",m=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],S=0;S<g.length;S++)U+=m[g[S]];c=parseFloat(U)}s<=21&&(u=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][s],f=1,s==12&&(u=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][l],f=2)),u!=null?(r[u]=i.length==1?i[0]:i,i=[]):i.push(c),e+=f}return r},a.cmap={},a.cmap.parse=function(t,e,n){t=new Uint8Array(t.buffer,e,n),e=0;var o=a._bin,r={};o.readUshort(t,e),e+=2;var i=o.readUshort(t,e);e+=2;var s=[];r.tables=[];for(var l=0;l<i;l++){var f=o.readUshort(t,e);e+=2;var u=o.readUshort(t,e);e+=2;var c=o.readUint(t,e);e+=4;var g="p"+f+"e"+u,y=s.indexOf(c);if(y==-1){var _;y=r.tables.length,s.push(c);var b=o.readUshort(t,c);b==0?_=a.cmap.parse0(t,c):b==4?_=a.cmap.parse4(t,c):b==6?_=a.cmap.parse6(t,c):b==12?_=a.cmap.parse12(t,c):console.debug("unknown format: "+b,f,u,c),r.tables.push(_)}if(r[g]!=null)throw"multiple tables for one platform+encoding";r[g]=y}return r},a.cmap.parse0=function(t,e){var n=a._bin,o={};o.format=n.readUshort(t,e),e+=2;var r=n.readUshort(t,e);e+=2,n.readUshort(t,e),e+=2,o.map=[];for(var i=0;i<r-6;i++)o.map.push(t[e+i]);return o},a.cmap.parse4=function(t,e){var n=a._bin,o=e,r={};r.format=n.readUshort(t,e),e+=2;var i=n.readUshort(t,e);e+=2,n.readUshort(t,e),e+=2;var s=n.readUshort(t,e);e+=2;var l=s/2;r.searchRange=n.readUshort(t,e),e+=2,r.entrySelector=n.readUshort(t,e),e+=2,r.rangeShift=n.readUshort(t,e),e+=2,r.endCount=n.readUshorts(t,e,l),e+=2*l,e+=2,r.startCount=n.readUshorts(t,e,l),e+=2*l,r.idDelta=[];for(var f=0;f<l;f++)r.idDelta.push(n.readShort(t,e)),e+=2;for(r.idRangeOffset=n.readUshorts(t,e,l),e+=2*l,r.glyphIdArray=[];e<o+i;)r.glyphIdArray.push(n.readUshort(t,e)),e+=2;return r},a.cmap.parse6=function(t,e){var n=a._bin,o={};o.format=n.readUshort(t,e),e+=2,n.readUshort(t,e),e+=2,n.readUshort(t,e),e+=2,o.firstCode=n.readUshort(t,e),e+=2;var r=n.readUshort(t,e);e+=2,o.glyphIdArray=[];for(var i=0;i<r;i++)o.glyphIdArray.push(n.readUshort(t,e)),e+=2;return o},a.cmap.parse12=function(t,e){var n=a._bin,o={};o.format=n.readUshort(t,e),e+=2,e+=2,n.readUint(t,e),e+=4,n.readUint(t,e),e+=4;var r=n.readUint(t,e);e+=4,o.groups=[];for(var i=0;i<r;i++){var s=e+12*i,l=n.readUint(t,s+0),f=n.readUint(t,s+4),u=n.readUint(t,s+8);o.groups.push([l,f,u])}return o},a.glyf={},a.glyf.parse=function(t,e,n,o){for(var r=[],i=0;i<o.maxp.numGlyphs;i++)r.push(null);return r},a.glyf._parseGlyf=function(t,e){var n=a._bin,o=t._data,r=a._tabOffset(o,"glyf",t._offset)+t.loca[e];if(t.loca[e]==t.loca[e+1])return null;var i={};if(i.noc=n.readShort(o,r),r+=2,i.xMin=n.readShort(o,r),r+=2,i.yMin=n.readShort(o,r),r+=2,i.xMax=n.readShort(o,r),r+=2,i.yMax=n.readShort(o,r),r+=2,i.xMin>=i.xMax||i.yMin>=i.yMax)return null;if(i.noc>0){i.endPts=[];for(var s=0;s<i.noc;s++)i.endPts.push(n.readUshort(o,r)),r+=2;var l=n.readUshort(o,r);if(r+=2,o.length-r<l)return null;i.instructions=n.readBytes(o,r,l),r+=l;var f=i.endPts[i.noc-1]+1;for(i.flags=[],s=0;s<f;s++){var u=o[r];if(r++,i.flags.push(u),(8&u)!=0){var c=o[r];r++;for(var g=0;g<c;g++)i.flags.push(u),s++}}for(i.xs=[],s=0;s<f;s++){var y=(2&i.flags[s])!=0,_=(16&i.flags[s])!=0;y?(i.xs.push(_?o[r]:-o[r]),r++):_?i.xs.push(0):(i.xs.push(n.readShort(o,r)),r+=2)}for(i.ys=[],s=0;s<f;s++)y=(4&i.flags[s])!=0,_=(32&i.flags[s])!=0,y?(i.ys.push(_?o[r]:-o[r]),r++):_?i.ys.push(0):(i.ys.push(n.readShort(o,r)),r+=2);var b=0,U=0;for(s=0;s<f;s++)b+=i.xs[s],U+=i.ys[s],i.xs[s]=b,i.ys[s]=U}else{var m;i.parts=[];do{m=n.readUshort(o,r),r+=2;var S={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(i.parts.push(S),S.glyphIndex=n.readUshort(o,r),r+=2,1&m){var w=n.readShort(o,r);r+=2;var k=n.readShort(o,r);r+=2}else w=n.readInt8(o,r),r++,k=n.readInt8(o,r),r++;2&m?(S.m.tx=w,S.m.ty=k):(S.p1=w,S.p2=k),8&m?(S.m.a=S.m.d=n.readF2dot14(o,r),r+=2):64&m?(S.m.a=n.readF2dot14(o,r),r+=2,S.m.d=n.readF2dot14(o,r),r+=2):128&m&&(S.m.a=n.readF2dot14(o,r),r+=2,S.m.b=n.readF2dot14(o,r),r+=2,S.m.c=n.readF2dot14(o,r),r+=2,S.m.d=n.readF2dot14(o,r),r+=2)}while(32&m);if(256&m){var T=n.readUshort(o,r);for(r+=2,i.instr=[],s=0;s<T;s++)i.instr.push(o[r]),r++}}return i},a.GDEF={},a.GDEF.parse=function(t,e,n,o){var r=e;e+=4;var i=a._bin.readUshort(t,e);return{glyphClassDef:i===0?null:a._lctf.readClassDef(t,r+i)}},a.GPOS={},a.GPOS.parse=function(t,e,n,o){return a._lctf.parse(t,e,n,o,a.GPOS.subt)},a.GPOS.subt=function(t,e,n,o){var r=a._bin,i=n,s={};if(s.fmt=r.readUshort(t,n),n+=2,e==1||e==2||e==3||e==7||e==8&&s.fmt<=2){var l=r.readUshort(t,n);n+=2,s.coverage=a._lctf.readCoverage(t,l+i)}if(e==1&&s.fmt==1){var f=r.readUshort(t,n);n+=2,f!=0&&(s.pos=a.GPOS.readValueRecord(t,n,f))}else if(e==2&&s.fmt>=1&&s.fmt<=2){f=r.readUshort(t,n),n+=2;var u=r.readUshort(t,n);n+=2;var c=a._lctf.numOfOnes(f),g=a._lctf.numOfOnes(u);if(s.fmt==1){s.pairsets=[];var y=r.readUshort(t,n);n+=2;for(var _=0;_<y;_++){var b=i+r.readUshort(t,n);n+=2;var U=r.readUshort(t,b);b+=2;for(var m=[],S=0;S<U;S++){var w=r.readUshort(t,b);b+=2,f!=0&&(p=a.GPOS.readValueRecord(t,b,f),b+=2*c),u!=0&&(F=a.GPOS.readValueRecord(t,b,u),b+=2*g),m.push({gid2:w,val1:p,val2:F})}s.pairsets.push(m)}}if(s.fmt==2){var k=r.readUshort(t,n);n+=2;var T=r.readUshort(t,n);n+=2;var G=r.readUshort(t,n);n+=2;var C=r.readUshort(t,n);for(n+=2,s.classDef1=a._lctf.readClassDef(t,i+k),s.classDef2=a._lctf.readClassDef(t,i+T),s.matrix=[],_=0;_<G;_++){var E=[];for(S=0;S<C;S++){var p=null,F=null;f!=0&&(p=a.GPOS.readValueRecord(t,n,f),n+=2*c),u!=0&&(F=a.GPOS.readValueRecord(t,n,u),n+=2*g),E.push({val1:p,val2:F})}s.matrix.push(E)}}}else if(e==4&&s.fmt==1)s.markCoverage=a._lctf.readCoverage(t,r.readUshort(t,n)+i),s.baseCoverage=a._lctf.readCoverage(t,r.readUshort(t,n+2)+i),s.markClassCount=r.readUshort(t,n+4),s.markArray=a.GPOS.readMarkArray(t,r.readUshort(t,n+6)+i),s.baseArray=a.GPOS.readBaseArray(t,r.readUshort(t,n+8)+i,s.markClassCount);else if(e==6&&s.fmt==1)s.mark1Coverage=a._lctf.readCoverage(t,r.readUshort(t,n)+i),s.mark2Coverage=a._lctf.readCoverage(t,r.readUshort(t,n+2)+i),s.markClassCount=r.readUshort(t,n+4),s.mark1Array=a.GPOS.readMarkArray(t,r.readUshort(t,n+6)+i),s.mark2Array=a.GPOS.readBaseArray(t,r.readUshort(t,n+8)+i,s.markClassCount);else{if(e==9&&s.fmt==1){var x=r.readUshort(t,n);n+=2;var B=r.readUint(t,n);if(n+=4,o.ltype==9)o.ltype=x;else if(o.ltype!=x)throw"invalid extension substitution";return a.GPOS.subt(t,o.ltype,i+B)}console.debug("unsupported GPOS table LookupType",e,"format",s.fmt)}return s},a.GPOS.readValueRecord=function(t,e,n){var o=a._bin,r=[];return r.push(1&n?o.readShort(t,e):0),e+=1&n?2:0,r.push(2&n?o.readShort(t,e):0),e+=2&n?2:0,r.push(4&n?o.readShort(t,e):0),e+=4&n?2:0,r.push(8&n?o.readShort(t,e):0),e+=8&n?2:0,r},a.GPOS.readBaseArray=function(t,e,n){var o=a._bin,r=[],i=e,s=o.readUshort(t,e);e+=2;for(var l=0;l<s;l++){for(var f=[],u=0;u<n;u++)f.push(a.GPOS.readAnchorRecord(t,i+o.readUshort(t,e))),e+=2;r.push(f)}return r},a.GPOS.readMarkArray=function(t,e){var n=a._bin,o=[],r=e,i=n.readUshort(t,e);e+=2;for(var s=0;s<i;s++){var l=a.GPOS.readAnchorRecord(t,n.readUshort(t,e+2)+r);l.markClass=n.readUshort(t,e),o.push(l),e+=4}return o},a.GPOS.readAnchorRecord=function(t,e){var n=a._bin,o={};return o.fmt=n.readUshort(t,e),o.x=n.readShort(t,e+2),o.y=n.readShort(t,e+4),o},a.GSUB={},a.GSUB.parse=function(t,e,n,o){return a._lctf.parse(t,e,n,o,a.GSUB.subt)},a.GSUB.subt=function(t,e,n,o){var r=a._bin,i=n,s={};if(s.fmt=r.readUshort(t,n),n+=2,e!=1&&e!=2&&e!=4&&e!=5&&e!=6)return null;if(e==1||e==2||e==4||e==5&&s.fmt<=2||e==6&&s.fmt<=2){var l=r.readUshort(t,n);n+=2,s.coverage=a._lctf.readCoverage(t,i+l)}if(e==1&&s.fmt>=1&&s.fmt<=2){if(s.fmt==1)s.delta=r.readShort(t,n),n+=2;else if(s.fmt==2){var f=r.readUshort(t,n);n+=2,s.newg=r.readUshorts(t,n,f),n+=2*s.newg.length}}else if(e==2&&s.fmt==1){f=r.readUshort(t,n),n+=2,s.seqs=[];for(var u=0;u<f;u++){var c=r.readUshort(t,n)+i;n+=2;var g=r.readUshort(t,c);s.seqs.push(r.readUshorts(t,c+2,g))}}else if(e==4)for(s.vals=[],f=r.readUshort(t,n),n+=2,u=0;u<f;u++){var y=r.readUshort(t,n);n+=2,s.vals.push(a.GSUB.readLigatureSet(t,i+y))}else if(e==5&&s.fmt==2){if(s.fmt==2){var _=r.readUshort(t,n);n+=2,s.cDef=a._lctf.readClassDef(t,i+_),s.scset=[];var b=r.readUshort(t,n);for(n+=2,u=0;u<b;u++){var U=r.readUshort(t,n);n+=2,s.scset.push(U==0?null:a.GSUB.readSubClassSet(t,i+U))}}}else if(e==6&&s.fmt==3){if(s.fmt==3){for(u=0;u<3;u++){f=r.readUshort(t,n),n+=2;for(var m=[],S=0;S<f;S++)m.push(a._lctf.readCoverage(t,i+r.readUshort(t,n+2*S)));n+=2*f,u==0&&(s.backCvg=m),u==1&&(s.inptCvg=m),u==2&&(s.ahedCvg=m)}f=r.readUshort(t,n),n+=2,s.lookupRec=a.GSUB.readSubstLookupRecords(t,n,f)}}else{if(e==7&&s.fmt==1){var w=r.readUshort(t,n);n+=2;var k=r.readUint(t,n);if(n+=4,o.ltype==9)o.ltype=w;else if(o.ltype!=w)throw"invalid extension substitution";return a.GSUB.subt(t,o.ltype,i+k)}console.debug("unsupported GSUB table LookupType",e,"format",s.fmt)}return s},a.GSUB.readSubClassSet=function(t,e){var n=a._bin.readUshort,o=e,r=[],i=n(t,e);e+=2;for(var s=0;s<i;s++){var l=n(t,e);e+=2,r.push(a.GSUB.readSubClassRule(t,o+l))}return r},a.GSUB.readSubClassRule=function(t,e){var n=a._bin.readUshort,o={},r=n(t,e),i=n(t,e+=2);e+=2,o.input=[];for(var s=0;s<r-1;s++)o.input.push(n(t,e)),e+=2;return o.substLookupRecords=a.GSUB.readSubstLookupRecords(t,e,i),o},a.GSUB.readSubstLookupRecords=function(t,e,n){for(var o=a._bin.readUshort,r=[],i=0;i<n;i++)r.push(o(t,e),o(t,e+2)),e+=4;return r},a.GSUB.readChainSubClassSet=function(t,e){var n=a._bin,o=e,r=[],i=n.readUshort(t,e);e+=2;for(var s=0;s<i;s++){var l=n.readUshort(t,e);e+=2,r.push(a.GSUB.readChainSubClassRule(t,o+l))}return r},a.GSUB.readChainSubClassRule=function(t,e){for(var n=a._bin,o={},r=["backtrack","input","lookahead"],i=0;i<r.length;i++){var s=n.readUshort(t,e);e+=2,i==1&&s--,o[r[i]]=n.readUshorts(t,e,s),e+=2*o[r[i]].length}return s=n.readUshort(t,e),e+=2,o.subst=n.readUshorts(t,e,2*s),e+=2*o.subst.length,o},a.GSUB.readLigatureSet=function(t,e){var n=a._bin,o=e,r=[],i=n.readUshort(t,e);e+=2;for(var s=0;s<i;s++){var l=n.readUshort(t,e);e+=2,r.push(a.GSUB.readLigature(t,o+l))}return r},a.GSUB.readLigature=function(t,e){var n=a._bin,o={chain:[]};o.nglyph=n.readUshort(t,e),e+=2;var r=n.readUshort(t,e);e+=2;for(var i=0;i<r-1;i++)o.chain.push(n.readUshort(t,e)),e+=2;return o},a.head={},a.head.parse=function(t,e,n){var o=a._bin,r={};return o.readFixed(t,e),e+=4,r.fontRevision=o.readFixed(t,e),e+=4,o.readUint(t,e),e+=4,o.readUint(t,e),e+=4,r.flags=o.readUshort(t,e),e+=2,r.unitsPerEm=o.readUshort(t,e),e+=2,r.created=o.readUint64(t,e),e+=8,r.modified=o.readUint64(t,e),e+=8,r.xMin=o.readShort(t,e),e+=2,r.yMin=o.readShort(t,e),e+=2,r.xMax=o.readShort(t,e),e+=2,r.yMax=o.readShort(t,e),e+=2,r.macStyle=o.readUshort(t,e),e+=2,r.lowestRecPPEM=o.readUshort(t,e),e+=2,r.fontDirectionHint=o.readShort(t,e),e+=2,r.indexToLocFormat=o.readShort(t,e),e+=2,r.glyphDataFormat=o.readShort(t,e),e+=2,r},a.hhea={},a.hhea.parse=function(t,e,n){var o=a._bin,r={};return o.readFixed(t,e),e+=4,r.ascender=o.readShort(t,e),e+=2,r.descender=o.readShort(t,e),e+=2,r.lineGap=o.readShort(t,e),e+=2,r.advanceWidthMax=o.readUshort(t,e),e+=2,r.minLeftSideBearing=o.readShort(t,e),e+=2,r.minRightSideBearing=o.readShort(t,e),e+=2,r.xMaxExtent=o.readShort(t,e),e+=2,r.caretSlopeRise=o.readShort(t,e),e+=2,r.caretSlopeRun=o.readShort(t,e),e+=2,r.caretOffset=o.readShort(t,e),e+=2,e+=8,r.metricDataFormat=o.readShort(t,e),e+=2,r.numberOfHMetrics=o.readUshort(t,e),e+=2,r},a.hmtx={},a.hmtx.parse=function(t,e,n,o){for(var r=a._bin,i={aWidth:[],lsBearing:[]},s=0,l=0,f=0;f<o.maxp.numGlyphs;f++)f<o.hhea.numberOfHMetrics&&(s=r.readUshort(t,e),e+=2,l=r.readShort(t,e),e+=2),i.aWidth.push(s),i.lsBearing.push(l);return i},a.kern={},a.kern.parse=function(t,e,n,o){var r=a._bin,i=r.readUshort(t,e);if(e+=2,i==1)return a.kern.parseV1(t,e-2,n,o);var s=r.readUshort(t,e);e+=2;for(var l={glyph1:[],rval:[]},f=0;f<s;f++){e+=2,n=r.readUshort(t,e),e+=2;var u=r.readUshort(t,e);e+=2;var c=u>>>8;if((c&=15)!=0)throw"unknown kern table format: "+c;e=a.kern.readFormat0(t,e,l)}return l},a.kern.parseV1=function(t,e,n,o){var r=a._bin;r.readFixed(t,e),e+=4;var i=r.readUint(t,e);e+=4;for(var s={glyph1:[],rval:[]},l=0;l<i;l++){r.readUint(t,e),e+=4;var f=r.readUshort(t,e);e+=2,r.readUshort(t,e),e+=2;var u=f>>>8;if((u&=15)!=0)throw"unknown kern table format: "+u;e=a.kern.readFormat0(t,e,s)}return s},a.kern.readFormat0=function(t,e,n){var o=a._bin,r=-1,i=o.readUshort(t,e);e+=2,o.readUshort(t,e),e+=2,o.readUshort(t,e),e+=2,o.readUshort(t,e),e+=2;for(var s=0;s<i;s++){var l=o.readUshort(t,e);e+=2;var f=o.readUshort(t,e);e+=2;var u=o.readShort(t,e);e+=2,l!=r&&(n.glyph1.push(l),n.rval.push({glyph2:[],vals:[]}));var c=n.rval[n.rval.length-1];c.glyph2.push(f),c.vals.push(u),r=l}return e},a.loca={},a.loca.parse=function(t,e,n,o){var r=a._bin,i=[],s=o.head.indexToLocFormat,l=o.maxp.numGlyphs+1;if(s==0)for(var f=0;f<l;f++)i.push(r.readUshort(t,e+(f<<1))<<1);if(s==1)for(f=0;f<l;f++)i.push(r.readUint(t,e+(f<<2)));return i},a.maxp={},a.maxp.parse=function(t,e,n){var o=a._bin,r={},i=o.readUint(t,e);return e+=4,r.numGlyphs=o.readUshort(t,e),e+=2,i==65536&&(r.maxPoints=o.readUshort(t,e),e+=2,r.maxContours=o.readUshort(t,e),e+=2,r.maxCompositePoints=o.readUshort(t,e),e+=2,r.maxCompositeContours=o.readUshort(t,e),e+=2,r.maxZones=o.readUshort(t,e),e+=2,r.maxTwilightPoints=o.readUshort(t,e),e+=2,r.maxStorage=o.readUshort(t,e),e+=2,r.maxFunctionDefs=o.readUshort(t,e),e+=2,r.maxInstructionDefs=o.readUshort(t,e),e+=2,r.maxStackElements=o.readUshort(t,e),e+=2,r.maxSizeOfInstructions=o.readUshort(t,e),e+=2,r.maxComponentElements=o.readUshort(t,e),e+=2,r.maxComponentDepth=o.readUshort(t,e),e+=2),r},a.name={},a.name.parse=function(t,e,n){var o=a._bin,r={};o.readUshort(t,e),e+=2;var i=o.readUshort(t,e);e+=2,o.readUshort(t,e);for(var s,l=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],f=e+=2,u=0;u<i;u++){var c=o.readUshort(t,e);e+=2;var g=o.readUshort(t,e);e+=2;var y=o.readUshort(t,e);e+=2;var _=o.readUshort(t,e);e+=2;var b=o.readUshort(t,e);e+=2;var U=o.readUshort(t,e);e+=2;var m,S=l[_],w=f+12*i+U;if(c==0)m=o.readUnicode(t,w,b/2);else if(c==3&&g==0)m=o.readUnicode(t,w,b/2);else if(g==0)m=o.readASCII(t,w,b);else if(g==1)m=o.readUnicode(t,w,b/2);else if(g==3)m=o.readUnicode(t,w,b/2);else{if(c!=1)throw"unknown encoding "+g+", platformID: "+c;m=o.readASCII(t,w,b),console.debug("reading unknown MAC encoding "+g+" as ASCII")}var k="p"+c+","+y.toString(16);r[k]==null&&(r[k]={}),r[k][S!==void 0?S:_]=m,r[k]._lang=y}for(var T in r)if(r[T].postScriptName!=null&&r[T]._lang==1033)return r[T];for(var T in r)if(r[T].postScriptName!=null&&r[T]._lang==0)return r[T];for(var T in r)if(r[T].postScriptName!=null&&r[T]._lang==3084)return r[T];for(var T in r)if(r[T].postScriptName!=null)return r[T];for(var T in r){s=T;break}return console.debug("returning name table with languageID "+r[s]._lang),r[s]},a["OS/2"]={},a["OS/2"].parse=function(t,e,n){var o=a._bin.readUshort(t,e);e+=2;var r={};if(o==0)a["OS/2"].version0(t,e,r);else if(o==1)a["OS/2"].version1(t,e,r);else if(o==2||o==3||o==4)a["OS/2"].version2(t,e,r);else{if(o!=5)throw"unknown OS/2 table version: "+o;a["OS/2"].version5(t,e,r)}return r},a["OS/2"].version0=function(t,e,n){var o=a._bin;return n.xAvgCharWidth=o.readShort(t,e),e+=2,n.usWeightClass=o.readUshort(t,e),e+=2,n.usWidthClass=o.readUshort(t,e),e+=2,n.fsType=o.readUshort(t,e),e+=2,n.ySubscriptXSize=o.readShort(t,e),e+=2,n.ySubscriptYSize=o.readShort(t,e),e+=2,n.ySubscriptXOffset=o.readShort(t,e),e+=2,n.ySubscriptYOffset=o.readShort(t,e),e+=2,n.ySuperscriptXSize=o.readShort(t,e),e+=2,n.ySuperscriptYSize=o.readShort(t,e),e+=2,n.ySuperscriptXOffset=o.readShort(t,e),e+=2,n.ySuperscriptYOffset=o.readShort(t,e),e+=2,n.yStrikeoutSize=o.readShort(t,e),e+=2,n.yStrikeoutPosition=o.readShort(t,e),e+=2,n.sFamilyClass=o.readShort(t,e),e+=2,n.panose=o.readBytes(t,e,10),e+=10,n.ulUnicodeRange1=o.readUint(t,e),e+=4,n.ulUnicodeRange2=o.readUint(t,e),e+=4,n.ulUnicodeRange3=o.readUint(t,e),e+=4,n.ulUnicodeRange4=o.readUint(t,e),e+=4,n.achVendID=[o.readInt8(t,e),o.readInt8(t,e+1),o.readInt8(t,e+2),o.readInt8(t,e+3)],e+=4,n.fsSelection=o.readUshort(t,e),e+=2,n.usFirstCharIndex=o.readUshort(t,e),e+=2,n.usLastCharIndex=o.readUshort(t,e),e+=2,n.sTypoAscender=o.readShort(t,e),e+=2,n.sTypoDescender=o.readShort(t,e),e+=2,n.sTypoLineGap=o.readShort(t,e),e+=2,n.usWinAscent=o.readUshort(t,e),e+=2,n.usWinDescent=o.readUshort(t,e),e+=2},a["OS/2"].version1=function(t,e,n){var o=a._bin;return e=a["OS/2"].version0(t,e,n),n.ulCodePageRange1=o.readUint(t,e),e+=4,n.ulCodePageRange2=o.readUint(t,e),e+=4},a["OS/2"].version2=function(t,e,n){var o=a._bin;return e=a["OS/2"].version1(t,e,n),n.sxHeight=o.readShort(t,e),e+=2,n.sCapHeight=o.readShort(t,e),e+=2,n.usDefault=o.readUshort(t,e),e+=2,n.usBreak=o.readUshort(t,e),e+=2,n.usMaxContext=o.readUshort(t,e),e+=2},a["OS/2"].version5=function(t,e,n){var o=a._bin;return e=a["OS/2"].version2(t,e,n),n.usLowerOpticalPointSize=o.readUshort(t,e),e+=2,n.usUpperOpticalPointSize=o.readUshort(t,e),e+=2},a.post={},a.post.parse=function(t,e,n){var o=a._bin,r={};return r.version=o.readFixed(t,e),e+=4,r.italicAngle=o.readFixed(t,e),e+=4,r.underlinePosition=o.readShort(t,e),e+=2,r.underlineThickness=o.readShort(t,e),e+=2,r},a==null&&(a={}),a.U==null&&(a.U={}),a.U.codeToGlyph=function(t,e){var n=t.cmap,o=-1;if(n.p0e4!=null?o=n.p0e4:n.p3e1!=null?o=n.p3e1:n.p1e0!=null?o=n.p1e0:n.p0e3!=null&&(o=n.p0e3),o==-1)throw"no familiar platform and encoding!";var r=n.tables[o];if(r.format==0)return e>=r.map.length?0:r.map[e];if(r.format==4){for(var i=-1,s=0;s<r.endCount.length;s++)if(e<=r.endCount[s]){i=s;break}return i==-1||r.startCount[i]>e?0:65535&(r.idRangeOffset[i]!=0?r.glyphIdArray[e-r.startCount[i]+(r.idRangeOffset[i]>>1)-(r.idRangeOffset.length-i)]:e+r.idDelta[i])}if(r.format==12){if(e>r.groups[r.groups.length-1][1])return 0;for(s=0;s<r.groups.length;s++){var l=r.groups[s];if(l[0]<=e&&e<=l[1])return l[2]+(e-l[0])}return 0}throw"unknown cmap table format "+r.format},a.U.glyphToPath=function(t,e){var n={cmds:[],crds:[]};if(t.SVG&&t.SVG.entries[e]){var o=t.SVG.entries[e];return o==null?n:(typeof o=="string"&&(o=a.SVG.toPath(o),t.SVG.entries[e]=o),o)}if(t.CFF){var r={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:t.CFF.Private?t.CFF.Private.defaultWidthX:0,open:!1},i=t.CFF,s=t.CFF.Private;if(i.ROS){for(var l=0;i.FDSelect[l+2]<=e;)l+=2;s=i.FDArray[i.FDSelect[l+1]].Private}a.U._drawCFF(t.CFF.CharStrings[e],r,i,s,n)}else t.glyf&&a.U._drawGlyf(e,t,n);return n},a.U._drawGlyf=function(t,e,n){var o=e.glyf[t];o==null&&(o=e.glyf[t]=a.glyf._parseGlyf(e,t)),o!=null&&(o.noc>-1?a.U._simpleGlyph(o,n):a.U._compoGlyph(o,e,n))},a.U._simpleGlyph=function(t,e){for(var n=0;n<t.noc;n++){for(var o=n==0?0:t.endPts[n-1]+1,r=t.endPts[n],i=o;i<=r;i++){var s=i==o?r:i-1,l=i==r?o:i+1,f=1&t.flags[i],u=1&t.flags[s],c=1&t.flags[l],g=t.xs[i],y=t.ys[i];if(i==o)if(f){if(!u){a.U.P.moveTo(e,g,y);continue}a.U.P.moveTo(e,t.xs[s],t.ys[s])}else u?a.U.P.moveTo(e,t.xs[s],t.ys[s]):a.U.P.moveTo(e,(t.xs[s]+g)/2,(t.ys[s]+y)/2);f?u&&a.U.P.lineTo(e,g,y):c?a.U.P.qcurveTo(e,g,y,t.xs[l],t.ys[l]):a.U.P.qcurveTo(e,g,y,(g+t.xs[l])/2,(y+t.ys[l])/2)}a.U.P.closePath(e)}},a.U._compoGlyph=function(t,e,n){for(var o=0;o<t.parts.length;o++){var r={cmds:[],crds:[]},i=t.parts[o];a.U._drawGlyf(i.glyphIndex,e,r);for(var s=i.m,l=0;l<r.crds.length;l+=2){var f=r.crds[l],u=r.crds[l+1];n.crds.push(f*s.a+u*s.b+s.tx),n.crds.push(f*s.c+u*s.d+s.ty)}for(l=0;l<r.cmds.length;l++)n.cmds.push(r.cmds[l])}},a.U._getGlyphClass=function(t,e){var n=a._lctf.getInterval(e,t);return n==-1?0:e[n+2]},a.U._applySubs=function(t,e,n,o){for(var r=t.length-e-1,i=0;i<n.tabs.length;i++)if(n.tabs[i]!=null){var s,l=n.tabs[i];if(!l.coverage||(s=a._lctf.coverageIndex(l.coverage,t[e]))!=-1){if(n.ltype==1)t[e],l.fmt==1?t[e]=t[e]+l.delta:t[e]=l.newg[s];else if(n.ltype==4)for(var f=l.vals[s],u=0;u<f.length;u++){var c=f[u],g=c.chain.length;if(!(g>r)){for(var y=!0,_=0,b=0;b<g;b++){for(;t[e+_+(1+b)]==-1;)_++;c.chain[b]!=t[e+_+(1+b)]&&(y=!1)}if(y){for(t[e]=c.nglyph,b=0;b<g+_;b++)t[e+b+1]=-1;break}}}else if(n.ltype==5&&l.fmt==2)for(var U=a._lctf.getInterval(l.cDef,t[e]),m=l.cDef[U+2],S=l.scset[m],w=0;w<S.length;w++){var k=S[w],T=k.input;if(!(T.length>r)){for(y=!0,b=0;b<T.length;b++){var G=a._lctf.getInterval(l.cDef,t[e+1+b]);if(U==-1&&l.cDef[G+2]!=T[b]){y=!1;break}}if(y){var C=k.substLookupRecords;for(u=0;u<C.length;u+=2)C[u],C[u+1]}}}else if(n.ltype==6&&l.fmt==3){if(!a.U._glsCovered(t,l.backCvg,e-l.backCvg.length)||!a.U._glsCovered(t,l.inptCvg,e)||!a.U._glsCovered(t,l.ahedCvg,e+l.inptCvg.length))continue;var E=l.lookupRec;for(w=0;w<E.length;w+=2){U=E[w];var p=o[E[w+1]];a.U._applySubs(t,e+U,p,o)}}}}},a.U._glsCovered=function(t,e,n){for(var o=0;o<e.length;o++)if(a._lctf.coverageIndex(e[o],t[n+o])==-1)return!1;return!0},a.U.glyphsToPath=function(t,e,n){for(var o={cmds:[],crds:[]},r=0,i=0;i<e.length;i++){var s=e[i];if(s!=-1){for(var l=i<e.length-1&&e[i+1]!=-1?e[i+1]:0,f=a.U.glyphToPath(t,s),u=0;u<f.crds.length;u+=2)o.crds.push(f.crds[u]+r),o.crds.push(f.crds[u+1]);for(n&&o.cmds.push(n),u=0;u<f.cmds.length;u++)o.cmds.push(f.cmds[u]);n&&o.cmds.push("X"),r+=t.hmtx.aWidth[s],i<e.length-1&&(r+=a.U.getPairAdjustment(t,s,l))}}return o},a.U.P={},a.U.P.moveTo=function(t,e,n){t.cmds.push("M"),t.crds.push(e,n)},a.U.P.lineTo=function(t,e,n){t.cmds.push("L"),t.crds.push(e,n)},a.U.P.curveTo=function(t,e,n,o,r,i,s){t.cmds.push("C"),t.crds.push(e,n,o,r,i,s)},a.U.P.qcurveTo=function(t,e,n,o,r){t.cmds.push("Q"),t.crds.push(e,n,o,r)},a.U.P.closePath=function(t){t.cmds.push("Z")},a.U._drawCFF=function(t,e,n,o,r){for(var i=e.stack,s=e.nStems,l=e.haveWidth,f=e.width,u=e.open,c=0,g=e.x,y=e.y,_=0,b=0,U=0,m=0,S=0,w=0,k=0,T=0,G=0,C=0,E={val:0,size:0};c<t.length;){a.CFF.getCharString(t,c,E);var p=E.val;if(c+=E.size,p=="o1"||p=="o18")i.length%2!=0&&!l&&(f=i.shift()+o.nominalWidthX),s+=i.length>>1,i.length=0,l=!0;else if(p=="o3"||p=="o23")i.length%2!=0&&!l&&(f=i.shift()+o.nominalWidthX),s+=i.length>>1,i.length=0,l=!0;else if(p=="o4")i.length>1&&!l&&(f=i.shift()+o.nominalWidthX,l=!0),u&&a.U.P.closePath(r),y+=i.pop(),a.U.P.moveTo(r,g,y),u=!0;else if(p=="o5")for(;i.length>0;)g+=i.shift(),y+=i.shift(),a.U.P.lineTo(r,g,y);else if(p=="o6"||p=="o7")for(var F=i.length,x=p=="o6",B=0;B<F;B++){var D=i.shift();x?g+=D:y+=D,x=!x,a.U.P.lineTo(r,g,y)}else if(p=="o8"||p=="o24"){F=i.length;for(var M=0;M+6<=F;)_=g+i.shift(),b=y+i.shift(),U=_+i.shift(),m=b+i.shift(),g=U+i.shift(),y=m+i.shift(),a.U.P.curveTo(r,_,b,U,m,g,y),M+=6;p=="o24"&&(g+=i.shift(),y+=i.shift(),a.U.P.lineTo(r,g,y))}else{if(p=="o11")break;if(p=="o1234"||p=="o1235"||p=="o1236"||p=="o1237")p=="o1234"&&(b=y,U=(_=g+i.shift())+i.shift(),C=m=b+i.shift(),w=m,T=y,g=(k=(S=(G=U+i.shift())+i.shift())+i.shift())+i.shift(),a.U.P.curveTo(r,_,b,U,m,G,C),a.U.P.curveTo(r,S,w,k,T,g,y)),p=="o1235"&&(_=g+i.shift(),b=y+i.shift(),U=_+i.shift(),m=b+i.shift(),G=U+i.shift(),C=m+i.shift(),S=G+i.shift(),w=C+i.shift(),k=S+i.shift(),T=w+i.shift(),g=k+i.shift(),y=T+i.shift(),i.shift(),a.U.P.curveTo(r,_,b,U,m,G,C),a.U.P.curveTo(r,S,w,k,T,g,y)),p=="o1236"&&(_=g+i.shift(),b=y+i.shift(),U=_+i.shift(),C=m=b+i.shift(),w=m,k=(S=(G=U+i.shift())+i.shift())+i.shift(),T=w+i.shift(),g=k+i.shift(),a.U.P.curveTo(r,_,b,U,m,G,C),a.U.P.curveTo(r,S,w,k,T,g,y)),p=="o1237"&&(_=g+i.shift(),b=y+i.shift(),U=_+i.shift(),m=b+i.shift(),G=U+i.shift(),C=m+i.shift(),S=G+i.shift(),w=C+i.shift(),k=S+i.shift(),T=w+i.shift(),Math.abs(k-g)>Math.abs(T-y)?g=k+i.shift():y=T+i.shift(),a.U.P.curveTo(r,_,b,U,m,G,C),a.U.P.curveTo(r,S,w,k,T,g,y));else if(p=="o14"){if(i.length>0&&!l&&(f=i.shift()+n.nominalWidthX,l=!0),i.length==4){var W=i.shift(),N=i.shift(),P=i.shift(),A=i.shift(),O=a.CFF.glyphBySE(n,P),I=a.CFF.glyphBySE(n,A);a.U._drawCFF(n.CharStrings[O],e,n,o,r),e.x=W,e.y=N,a.U._drawCFF(n.CharStrings[I],e,n,o,r)}u&&(a.U.P.closePath(r),u=!1)}else if(p=="o19"||p=="o20")i.length%2!=0&&!l&&(f=i.shift()+o.nominalWidthX),s+=i.length>>1,i.length=0,l=!0,c+=s+7>>3;else if(p=="o21")i.length>2&&!l&&(f=i.shift()+o.nominalWidthX,l=!0),y+=i.pop(),g+=i.pop(),u&&a.U.P.closePath(r),a.U.P.moveTo(r,g,y),u=!0;else if(p=="o22")i.length>1&&!l&&(f=i.shift()+o.nominalWidthX,l=!0),g+=i.pop(),u&&a.U.P.closePath(r),a.U.P.moveTo(r,g,y),u=!0;else if(p=="o25"){for(;i.length>6;)g+=i.shift(),y+=i.shift(),a.U.P.lineTo(r,g,y);_=g+i.shift(),b=y+i.shift(),U=_+i.shift(),m=b+i.shift(),g=U+i.shift(),y=m+i.shift(),a.U.P.curveTo(r,_,b,U,m,g,y)}else if(p=="o26")for(i.length%2&&(g+=i.shift());i.length>0;)_=g,b=y+i.shift(),g=U=_+i.shift(),y=(m=b+i.shift())+i.shift(),a.U.P.curveTo(r,_,b,U,m,g,y);else if(p=="o27")for(i.length%2&&(y+=i.shift());i.length>0;)b=y,U=(_=g+i.shift())+i.shift(),m=b+i.shift(),g=U+i.shift(),y=m,a.U.P.curveTo(r,_,b,U,m,g,y);else if(p=="o10"||p=="o29"){var R=p=="o10"?o:n;if(i.length==0)console.debug("error: empty stack");else{var L=i.pop(),V=R.Subrs[L+R.Bias];e.x=g,e.y=y,e.nStems=s,e.haveWidth=l,e.width=f,e.open=u,a.U._drawCFF(V,e,n,o,r),g=e.x,y=e.y,s=e.nStems,l=e.haveWidth,f=e.width,u=e.open}}else if(p=="o30"||p=="o31"){var q=i.length,$=(M=0,p=="o31");for(M+=q-(F=-3&q);M<F;)$?(b=y,U=(_=g+i.shift())+i.shift(),y=(m=b+i.shift())+i.shift(),F-M==5?(g=U+i.shift(),M++):g=U,$=!1):(_=g,b=y+i.shift(),U=_+i.shift(),m=b+i.shift(),g=U+i.shift(),F-M==5?(y=m+i.shift(),M++):y=m,$=!0),a.U.P.curveTo(r,_,b,U,m,g,y),M+=4}else{if((p+"").charAt(0)=="o")throw console.debug("Unknown operation: "+p,t),p;i.push(p)}}}e.x=g,e.y=y,e.nStems=s,e.haveWidth=l,e.width=f,e.open=u};var h=a,d={Typr:h};return v.Typr=h,v.default=d,Object.defineProperty(v,"__esModule",{value:!0}),v}({}).Typr}/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/function Jt(){return function(v){var a=Uint8Array,h=Uint16Array,d=Uint32Array,t=new a([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),e=new a([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),n=new a([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),o=function(p,F){for(var x=new h(31),B=0;B<31;++B)x[B]=F+=1<<p[B-1];var D=new d(x[30]);for(B=1;B<30;++B)for(var M=x[B];M<x[B+1];++M)D[M]=M-x[B]<<5|B;return[x,D]},r=o(t,2),i=r[0],s=r[1];i[28]=258,s[258]=28;for(var l=o(e,0)[0],f=new h(32768),u=0;u<32768;++u){var c=(43690&u)>>>1|(21845&u)<<1;c=(61680&(c=(52428&c)>>>2|(13107&c)<<2))>>>4|(3855&c)<<4,f[u]=((65280&c)>>>8|(255&c)<<8)>>>1}var g=function(p,F,x){for(var B=p.length,D=0,M=new h(F);D<B;++D)++M[p[D]-1];var W,N=new h(F);for(D=0;D<F;++D)N[D]=N[D-1]+M[D-1]<<1;if(x){W=new h(1<<F);var P=15-F;for(D=0;D<B;++D)if(p[D])for(var A=D<<4|p[D],O=F-p[D],I=N[p[D]-1]++<<O,R=I|(1<<O)-1;I<=R;++I)W[f[I]>>>P]=A}else for(W=new h(B),D=0;D<B;++D)p[D]&&(W[D]=f[N[p[D]-1]++]>>>15-p[D]);return W},y=new a(288);for(u=0;u<144;++u)y[u]=8;for(u=144;u<256;++u)y[u]=9;for(u=256;u<280;++u)y[u]=7;for(u=280;u<288;++u)y[u]=8;var _=new a(32);for(u=0;u<32;++u)_[u]=5;var b=g(y,9,1),U=g(_,5,1),m=function(p){for(var F=p[0],x=1;x<p.length;++x)p[x]>F&&(F=p[x]);return F},S=function(p,F,x){var B=F/8|0;return(p[B]|p[B+1]<<8)>>(7&F)&x},w=function(p,F){var x=F/8|0;return(p[x]|p[x+1]<<8|p[x+2]<<16)>>(7&F)},k=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(p,F,x){var B=new Error(F||k[p]);if(B.code=p,Error.captureStackTrace&&Error.captureStackTrace(B,T),!x)throw B;return B},G=function(p,F,x){var B=p.length;if(!B||x&&!x.l&&B<5)return F||new a(0);var D=!F||x,M=!x||x.i;x||(x={}),F||(F=new a(3*B));var W,N=function(J){var ye=F.length;if(J>ye){var me=new a(Math.max(2*ye,J));me.set(F),F=me}},P=x.f||0,A=x.p||0,O=x.b||0,I=x.l,R=x.d,L=x.m,V=x.n,q=8*B;do{if(!I){x.f=P=S(p,A,1);var $=S(p,A+1,3);if(A+=3,!$){var se=p[(Te=((W=A)/8|0)+(7&W&&1)+4)-4]|p[Te-3]<<8,Y=Te+se;if(Y>B){M&&T(0);break}D&&N(O+se),F.set(p.subarray(Te,Y),O),x.b=O+=se,x.p=A=8*Y;continue}if($==1)I=b,R=U,L=9,V=5;else if($==2){var z=S(p,A,31)+257,ee=S(p,A+10,15)+4,fe=z+S(p,A+5,31)+1;A+=14;for(var K=new a(fe),ue=new a(19),oe=0;oe<ee;++oe)ue[n[oe]]=S(p,A+3*oe,7);A+=3*ee;var pe=m(ue),Ye=(1<<pe)-1,De=g(ue,pe,1);for(oe=0;oe<fe;){var Te,ge=De[S(p,A,Ye)];if(A+=15&ge,(Te=ge>>>4)<16)K[oe++]=Te;else{var ve=0,Se=0;for(Te==16?(Se=3+S(p,A,3),A+=2,ve=K[oe-1]):Te==17?(Se=3+S(p,A,7),A+=3):Te==18&&(Se=11+S(p,A,127),A+=7);Se--;)K[oe++]=ve}}var Ce=K.subarray(0,z),ce=K.subarray(z);L=m(Ce),V=m(ce),I=g(Ce,L,1),R=g(ce,V,1)}else T(1);if(A>q){M&&T(0);break}}D&&N(O+131072);for(var Le=(1<<L)-1,j=(1<<V)-1,he=A;;he=A){var ne=(ve=I[w(p,A)&Le])>>>4;if((A+=15&ve)>q){M&&T(0);break}if(ve||T(2),ne<256)F[O++]=ne;else{if(ne==256){he=A,I=null;break}var ae=ne-254;if(ne>264){var le=t[oe=ne-257];ae=S(p,A,(1<<le)-1)+i[oe],A+=le}var be=R[w(p,A)&j],Q=be>>>4;if(be||T(3),A+=15&be,ce=l[Q],Q>3&&(le=e[Q],ce+=w(p,A)&(1<<le)-1,A+=le),A>q){M&&T(0);break}D&&N(O+131072);for(var _e=O+ae;O<_e;O+=4)F[O]=F[O-ce],F[O+1]=F[O+1-ce],F[O+2]=F[O+2-ce],F[O+3]=F[O+3-ce];O=_e}}x.l=I,x.p=he,x.b=O,I&&(P=1,x.m=L,x.d=R,x.n=V)}while(!P);return O==F.length?F:function(J,ye,me){(ye==null||ye<0)&&(ye=0),(me==null||me>J.length)&&(me=J.length);var we=new(J instanceof h?h:J instanceof d?d:a)(me-ye);return we.set(J.subarray(ye,me)),we}(F,0,O)},C=new a(0),E=typeof TextDecoder<"u"&&new TextDecoder;try{E.decode(C,{stream:!0})}catch{}return v.convert_streams=function(p){var F=new DataView(p),x=0;function B(){var z=F.getUint16(x);return x+=2,z}function D(){var z=F.getUint32(x);return x+=4,z}function M(z){se.setUint16(Y,z),Y+=2}function W(z){se.setUint32(Y,z),Y+=4}for(var N={signature:D(),flavor:D(),length:D(),numTables:B(),reserved:B(),totalSfntSize:D(),majorVersion:B(),minorVersion:B(),metaOffset:D(),metaLength:D(),metaOrigLength:D(),privOffset:D(),privLength:D()},P=0;Math.pow(2,P)<=N.numTables;)P++;P--;for(var A=16*Math.pow(2,P),O=16*N.numTables-A,I=12,R=[],L=0;L<N.numTables;L++)R.push({tag:D(),offset:D(),compLength:D(),origLength:D(),origChecksum:D()}),I+=16;var V,q=new Uint8Array(12+16*R.length+R.reduce(function(z,ee){return z+ee.origLength+4},0)),$=q.buffer,se=new DataView($),Y=0;return W(N.flavor),M(N.numTables),M(A),M(P),M(O),R.forEach(function(z){W(z.tag),W(z.origChecksum),W(I),W(z.origLength),z.outOffset=I,(I+=z.origLength)%4!=0&&(I+=4-I%4)}),R.forEach(function(z){var ee,fe=p.slice(z.offset,z.offset+z.compLength);if(z.compLength!=z.origLength){var K=new Uint8Array(z.origLength);ee=new Uint8Array(fe,2),G(ee,K)}else K=new Uint8Array(fe);q.set(K,z.outOffset);var ue=0;(I=z.outOffset+z.origLength)%4!=0&&(ue=4-I%4),q.set(new Uint8Array(ue).buffer,z.outOffset+z.origLength),V=I+ue}),$.slice(0,V)},Object.defineProperty(v,"__esModule",{value:!0}),v}({}).convert_streams}function Yt(v,a){const h={M:2,L:2,Q:4,C:6,Z:0},d={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},t=1,e=2,n=4,o=8,r=16,i=32;let s;function l(k){if(!s){const T={R:e,L:t,D:n,C:r,U:i,T:o};s=new Map;for(let G in d){let C=0;d[G].split(",").forEach(E=>{let[p,F]=E.split("+");p=parseInt(p,36),F=F?parseInt(F,36):0,s.set(C+=p,T[G]);for(let x=F;x--;)s.set(++C,T[G])})}}return s.get(k)||i}const f=1,u=2,c=3,g=4,y=[null,"isol","init","fina","medi"];function _(k){const T=new Uint8Array(k.length);let G=i,C=f,E=-1;for(let p=0;p<k.length;p++){const F=k.codePointAt(p);let x=l(F)|0,B=f;x&o||(G&(t|n|r)?x&(e|n|r)?(B=c,(C===f||C===c)&&T[E]++):x&(t|i)&&(C===u||C===g)&&T[E]--:G&(e|i)&&(C===u||C===g)&&T[E]--,C=T[p]=B,G=x,E=p,F>65535&&p++)}return T}function b(k,T){const G=[];for(let E=0;E<T.length;E++){const p=T.codePointAt(E);p>65535&&E++,G.push(v.U.codeToGlyph(k,p))}const C=k.GSUB;if(C){const{lookupList:E,featureList:p}=C;let F;const x=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,B=[];p.forEach(D=>{if(x.test(D.tag))for(let M=0;M<D.tab.length;M++){if(B[D.tab[M]])continue;B[D.tab[M]]=!0;const W=E[D.tab[M]],N=/^(isol|init|fina|medi)$/.test(D.tag);N&&!F&&(F=_(T));for(let P=0;P<G.length;P++)(!F||!N||y[F[P]]===D.tag)&&v.U._applySubs(G,P,W,E)}})}return G}function U(k,T){const G=new Int16Array(T.length*3);let C=0;for(;C<T.length;C++){const x=T[C];if(x===-1)continue;G[C*3+2]=k.hmtx.aWidth[x];const B=k.GPOS;if(B){const D=B.lookupList;for(let M=0;M<D.length;M++){const W=D[M];for(let N=0;N<W.tabs.length;N++){const P=W.tabs[N];if(W.ltype===1){if(v._lctf.coverageIndex(P.coverage,x)!==-1&&P.pos){F(P.pos,C);break}}else if(W.ltype===2){let A=null,O=E();if(O!==-1){const I=v._lctf.coverageIndex(P.coverage,T[O]);if(I!==-1){if(P.fmt===1){const R=P.pairsets[I];for(let L=0;L<R.length;L++)R[L].gid2===x&&(A=R[L])}else if(P.fmt===2){const R=v.U._getGlyphClass(T[O],P.classDef1),L=v.U._getGlyphClass(x,P.classDef2);A=P.matrix[R][L]}if(A){A.val1&&F(A.val1,O),A.val2&&F(A.val2,C);break}}}}else if(W.ltype===4){const A=v._lctf.coverageIndex(P.markCoverage,x);if(A!==-1){const O=E(p),I=O===-1?-1:v._lctf.coverageIndex(P.baseCoverage,T[O]);if(I!==-1){const R=P.markArray[A],L=P.baseArray[I][R.markClass];G[C*3]=L.x-R.x+G[O*3]-G[O*3+2],G[C*3+1]=L.y-R.y+G[O*3+1];break}}}else if(W.ltype===6){const A=v._lctf.coverageIndex(P.mark1Coverage,x);if(A!==-1){const O=E();if(O!==-1){const I=T[O];if(m(k,I)===3){const R=v._lctf.coverageIndex(P.mark2Coverage,I);if(R!==-1){const L=P.mark1Array[A],V=P.mark2Array[R][L.markClass];G[C*3]=V.x-L.x+G[O*3]-G[O*3+2],G[C*3+1]=V.y-L.y+G[O*3+1];break}}}}}}}}else if(k.kern&&!k.cff){const D=E();if(D!==-1){const M=k.kern.glyph1.indexOf(T[D]);if(M!==-1){const W=k.kern.rval[M].glyph2.indexOf(x);W!==-1&&(G[D*3+2]+=k.kern.rval[M].vals[W])}}}}return G;function E(x){for(let B=C-1;B>=0;B--)if(T[B]!==-1&&(!x||x(T[B])))return B;return-1}function p(x){return m(k,x)===1}function F(x,B){for(let D=0;D<3;D++)G[B*3+D]+=x[D]||0}}function m(k,T){const G=k.GDEF&&k.GDEF.glyphClassDef;return G?v.U._getGlyphClass(T,G):0}function S(...k){for(let T=0;T<k.length;T++)if(typeof k[T]=="number")return k[T]}function w(k){const T=Object.create(null),G=k["OS/2"],C=k.hhea,E=k.head.unitsPerEm,p=S(G&&G.sTypoAscender,C&&C.ascender,E),F={unitsPerEm:E,ascender:p,descender:S(G&&G.sTypoDescender,C&&C.descender,0),capHeight:S(G&&G.sCapHeight,p),xHeight:S(G&&G.sxHeight,p),lineGap:S(G&&G.sTypoLineGap,C&&C.lineGap),supportsCodePoint(x){return v.U.codeToGlyph(k,x)>0},forEachGlyph(x,B,D,M){let W=0;const N=1/F.unitsPerEm*B,P=b(k,x);let A=0;const O=U(k,P);return P.forEach((I,R)=>{if(I!==-1){let L=T[I];if(!L){const{cmds:V,crds:q}=v.U.glyphToPath(k,I);let $="",se=0;for(let K=0,ue=V.length;K<ue;K++){const oe=h[V[K]];$+=V[K];for(let pe=1;pe<=oe;pe++)$+=(pe>1?",":"")+q[se++]}let Y,z,ee,fe;if(q.length){Y=z=1/0,ee=fe=-1/0;for(let K=0,ue=q.length;K<ue;K+=2){let oe=q[K],pe=q[K+1];oe<Y&&(Y=oe),pe<z&&(z=pe),oe>ee&&(ee=oe),pe>fe&&(fe=pe)}}else Y=ee=z=fe=0;L=T[I]={index:I,advanceWidth:k.hmtx.aWidth[I],xMin:Y,yMin:z,xMax:ee,yMax:fe,path:$}}M.call(null,L,W+O[R*3]*N,O[R*3+1]*N,A),W+=O[R*3+2]*N,D&&(W+=D*B)}A+=x.codePointAt(A)>65535?2:1}),W}};return F}return function(T){const G=new Uint8Array(T,0,4),C=v._bin.readASCII(G,0,4);if(C==="wOFF")T=a(T);else if(C==="wOF2")throw new Error("woff2 fonts not supported");return w(v.parse(T)[0])}}const Kt=Pe({name:"Typr Font Parser",dependencies:[$t,Jt,Yt],init(v,a,h){const d=v(),t=a();return h(d,t)}});/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/function Qt(){return function(v){var a=function(){this.buckets=new Map};a.prototype.add=function(U){var m=U>>5;this.buckets.set(m,(this.buckets.get(m)||0)|1<<(31&U))},a.prototype.has=function(U){var m=this.buckets.get(U>>5);return m!==void 0&&(m&1<<(31&U))!=0},a.prototype.serialize=function(){var U=[];return this.buckets.forEach(function(m,S){U.push((+S).toString(36)+":"+m.toString(36))}),U.join(",")},a.prototype.deserialize=function(U){var m=this;this.buckets.clear(),U.split(",").forEach(function(S){var w=S.split(":");m.buckets.set(parseInt(w[0],36),parseInt(w[1],36))})};var h=Math.pow(2,8),d=h-1,t=~d;function e(U){var m=function(w){return w&t}(U).toString(16),S=function(w){return(w&t)+h-1}(U).toString(16);return"codepoint-index/plane"+(U>>16)+"/"+m+"-"+S+".json"}function n(U,m){var S=U&d,w=m.codePointAt(S/6|0);return((w=(w||48)-48)&1<<S%6)!=0}function o(U,m){var S;(S=U,S.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map(function(w){return w.split("-").map(function(k){return parseInt(k.trim(),16)})})).forEach(function(w){var k=w[0],T=w[1];T===void 0&&(T=k),m(k,T)})}function r(U,m){o(U,function(S,w){for(var k=S;k<=w;k++)m(k)})}var i={},s={},l=new WeakMap,f="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function u(U){var m=l.get(U);return m||(m=new a,r(U.ranges,function(S){return m.add(S)}),l.set(U,m)),m}var c,g=new Map;function y(U,m,S){return U[m]?m:U[S]?S:function(w){for(var k in w)return k}(U)}function _(U,m){var S=m;if(!U.includes(S)){S=1/0;for(var w=0;w<U.length;w++)Math.abs(U[w]-m)<Math.abs(S-m)&&(S=U[w])}return S}function b(U){return c||(c=new Set,r("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",function(m){c.add(m)})),c.has(U)}return v.CodePointSet=a,v.clearCache=function(){i={},s={}},v.getFontsForString=function(U,m){m===void 0&&(m={});var S,w=m.lang;w===void 0&&(w=new RegExp("\\p{Script=Hangul}","u").test(S=U)?"ko":new RegExp("\\p{Script=Hiragana}|\\p{Script=Katakana}","u").test(S)?"ja":"en");var k=m.category;k===void 0&&(k="sans-serif");var T=m.style;T===void 0&&(T="normal");var G=m.weight;G===void 0&&(G=400);var C=(m.dataUrl||f).replace(/\/$/g,""),E=new Map,p=new Uint8Array(U.length),F={},x={},B=new Array(U.length),D=new Map,M=!1;function W(A){var O=g.get(A);return O||(O=fetch(C+"/"+A).then(function(I){if(!I.ok)throw new Error(I.statusText);return I.json().then(function(R){if(!Array.isArray(R)||R[0]!==1)throw new Error("Incorrect schema version; need 1, got "+R[0]);return R[1]})}).catch(function(I){if(C!==f)return M||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+C+'", trying default CDN. '+I.message),M=!0),C=f,g.delete(A),W(A);throw I}),g.set(A,O)),O}for(var N=function(A){var O=U.codePointAt(A),I=e(O);B[A]=I,i[I]||D.has(I)||D.set(I,W(I).then(function(R){i[I]=R})),O>65535&&(A++,P=A)},P=0;P<U.length;P++)N(P);return Promise.all(D.values()).then(function(){D.clear();for(var A=function(I){var R=U.codePointAt(I),L=null,V=i[B[I]],q=void 0;for(var $ in V){var se=x[$];if(se===void 0&&(se=x[$]=new RegExp($).test(w||"en")),se){for(var Y in q=$,V[$])if(n(R,V[$][Y])){L=Y;break}break}}if(!L){e:for(var z in V)if(z!==q){for(var ee in V[z])if(n(R,V[z][ee])){L=ee;break e}}}L||(console.debug("No font coverage for U+"+R.toString(16)),L="latin"),B[I]=L,s[L]||D.has(L)||D.set(L,W("font-meta/"+L+".json").then(function(fe){s[L]=fe})),R>65535&&(I++,O=I)},O=0;O<U.length;O++)A(O);return Promise.all(D.values())}).then(function(){for(var A,O=null,I=0;I<U.length;I++){var R=U.codePointAt(I);if(O&&(b(R)||u(O).has(R)))p[I]=p[I-1];else{O=s[B[I]];var L=F[O.id];if(!L){var V=O.typeforms,q=y(V,k,"sans-serif"),$=y(V[q],T,"normal"),se=_((A=V[q])===null||A===void 0?void 0:A[$],G);L=F[O.id]=C+"/font-files/"+O.id+"/"+q+"."+$+"."+se+".woff"}var Y=E.get(L);Y==null&&(Y=E.size,E.set(L,Y)),p[I]=Y}R>65535&&(I++,p[I]=p[I-1])}return{fontUrls:Array.from(E.keys()),chars:p}})},Object.defineProperty(v,"__esModule",{value:!0}),v}({})}function Zt(v,a){const h=Object.create(null),d=Object.create(null);function t(n,o){const r=i=>{console.error(`Failure loading font ${n}`,i)};try{const i=new XMLHttpRequest;i.open("get",n,!0),i.responseType="arraybuffer",i.onload=function(){if(i.status>=400)r(new Error(i.statusText));else if(i.status>0)try{const s=v(i.response);s.src=n,o(s)}catch(s){r(s)}},i.onerror=r,i.send()}catch(i){r(i)}}function e(n,o){let r=h[n];r?o(r):d[n]?d[n].push(o):(d[n]=[o],t(n,i=>{i.src=n,h[n]=i,d[n].forEach(s=>s(i)),delete d[n]}))}return function(n,o,{lang:r,fonts:i=[],style:s="normal",weight:l="normal",unicodeFontsURL:f}={}){const u=new Uint8Array(n.length),c=[];n.length||b();const g=new Map,y=[];if(s!=="italic"&&(s="normal"),typeof l!="number"&&(l=l==="bold"?700:400),i&&!Array.isArray(i)&&(i=[i]),i=i.slice().filter(m=>!m.lang||m.lang.test(r)).reverse(),i.length){let k=0;(function T(G=0){for(let C=G,E=n.length;C<E;C++){const p=n.codePointAt(C);if(k===1&&c[u[C-1]].supportsCodePoint(p)||/\s/.test(n[C]))u[C]=u[C-1],k===2&&(y[y.length-1][1]=C);else for(let F=u[C],x=i.length;F<=x;F++)if(F===x){const B=k===2?y[y.length-1]:y[y.length]=[C,C];B[1]=C,k=2}else{u[C]=F;const{src:B,unicodeRange:D}=i[F];if(!D||U(p,D)){const M=h[B];if(!M){e(B,()=>{T(C)});return}if(M.supportsCodePoint(p)){let W=g.get(M);typeof W!="number"&&(W=c.length,c.push(M),g.set(M,W)),u[C]=W,k=1;break}}}p>65535&&C+1<E&&(u[C+1]=u[C],C++,k===2&&(y[y.length-1][1]=C))}_()})()}else y.push([0,n.length-1]),_();function _(){if(y.length){const m=y.map(S=>n.substring(S[0],S[1]+1)).join(`
`);a.getFontsForString(m,{lang:r||void 0,style:s,weight:l,dataUrl:f}).then(({fontUrls:S,chars:w})=>{const k=c.length;let T=0;y.forEach(C=>{for(let E=0,p=C[1]-C[0];E<=p;E++)u[C[0]+E]=w[T++]+k;T++});let G=0;S.forEach((C,E)=>{e(C,p=>{c[E+k]=p,++G===S.length&&b()})})})}else b()}function b(){o({chars:u,fonts:c})}function U(m,S){for(let w=0;w<S.length;w++){const[k,T=k]=S[w];if(k<=m&&m<=T)return!0}return!1}}}const er=Pe({name:"FontResolver",dependencies:[Zt,Kt,Qt],init(v,a,h){return v(a,h())}});function tr(v,a){const d=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,t="[^\\S\\u00A0]",e=new RegExp(`${t}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function n({text:c,lang:g,fonts:y,style:_,weight:b,preResolvedFonts:U,unicodeFontsURL:m},S){const w=({chars:k,fonts:T})=>{let G,C;const E=[];for(let p=0;p<k.length;p++)k[p]!==C?(C=k[p],E.push(G={start:p,end:p,fontObj:T[k[p]]})):G.end=p;S(E)};U?w(U):v(c,w,{lang:g,fonts:y,style:_,weight:b,unicodeFontsURL:m})}function o({text:c="",font:g,lang:y,sdfGlyphSize:_=64,fontSize:b=400,fontWeight:U=1,fontStyle:m="normal",letterSpacing:S=0,lineHeight:w="normal",maxWidth:k=1/0,direction:T,textAlign:G="left",textIndent:C=0,whiteSpace:E="normal",overflowWrap:p="normal",anchorX:F=0,anchorY:x=0,metricsOnly:B=!1,unicodeFontsURL:D,preResolvedFonts:M=null,includeCaretPositions:W=!1,chunkedBoundsSize:N=8192,colorRanges:P=null},A){const O=l(),I={fontLoad:0,typesetting:0};c.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),c=c.replace(/\r\n/g,`
`).replace(/\r/g,`
`)),b=+b,S=+S,k=+k,w=w||"normal",C=+C,n({text:c,lang:y,style:m,weight:U,fonts:typeof g=="string"?[{src:g}]:g,unicodeFontsURL:D,preResolvedFonts:M},R=>{I.fontLoad=l()-O;const L=isFinite(k);let V=null,q=null,$=null,se=null,Y=null,z=null,ee=null,fe=null,K=0,ue=0,oe=E!=="nowrap";const pe=new Map,Ye=l();let De=C,Te=0,ge=new f;const ve=[ge];R.forEach(j=>{const{fontObj:he}=j,{ascender:ne,descender:ae,unitsPerEm:le,lineGap:be,capHeight:Q,xHeight:_e}=he;let J=pe.get(he);if(!J){const Z=b/le,te=w==="normal"?(ne-ae+be)*Z:w*b,Me=(te-(ne-ae)*Z)/2,re=Math.min(te,(ne-ae)*Z),X=(ne+ae)/2*Z+re/2;J={index:pe.size,src:he.src,fontObj:he,fontSizeMult:Z,unitsPerEm:le,ascender:ne*Z,descender:ae*Z,capHeight:Q*Z,xHeight:_e*Z,lineHeight:te,baseline:-Me-ne*Z,caretTop:X,caretBottom:X-re},pe.set(he,J)}const{fontSizeMult:ye}=J,me=c.slice(j.start,j.end+1);let we,Ae;he.forEachGlyph(me,b,S,(Z,te,Me,re)=>{te+=Te,re+=j.start,we=te,Ae=Z;const X=c.charAt(re),Ue=Z.advanceWidth*ye,xe=ge.count;let H;if("isEmpty"in Z||(Z.isWhitespace=!!X&&new RegExp(t).test(X),Z.canBreakAfter=!!X&&e.test(X),Z.isEmpty=Z.xMin===Z.xMax||Z.yMin===Z.yMax||d.test(X)),!Z.isWhitespace&&!Z.isEmpty&&ue++,oe&&L&&!Z.isWhitespace&&te+Ue+De>k&&xe){if(ge.glyphAt(xe-1).glyphObj.canBreakAfter)H=new f,De=-te;else for(let Fe=xe;Fe--;)if(Fe===0&&p==="break-word"){H=new f,De=-te;break}else if(ge.glyphAt(Fe).glyphObj.canBreakAfter){H=ge.splitAt(Fe+1);const ke=H.glyphAt(0).x;De-=ke;for(let de=H.count;de--;)H.glyphAt(de).x-=ke;break}H&&(ge.isSoftWrapped=!0,ge=H,ve.push(ge),K=k)}let ie=ge.glyphAt(ge.count);ie.glyphObj=Z,ie.x=te+De,ie.y=Me,ie.width=Ue,ie.charIndex=re,ie.fontData=J,X===`
`&&(ge=new f,ve.push(ge),De=-(te+Ue+S*b)+C)}),Te=we+Ae.advanceWidth*ye+S*b});let Se=0;ve.forEach(j=>{let he=!0;for(let ne=j.count;ne--;){const ae=j.glyphAt(ne);he&&!ae.glyphObj.isWhitespace&&(j.width=ae.x+ae.width,j.width>K&&(K=j.width),he=!1);let{lineHeight:le,capHeight:be,xHeight:Q,baseline:_e}=ae.fontData;le>j.lineHeight&&(j.lineHeight=le);const J=_e-j.baseline;J<0&&(j.baseline+=J,j.cap+=J,j.ex+=J),j.cap=Math.max(j.cap,j.baseline+be),j.ex=Math.max(j.ex,j.baseline+Q)}j.baseline-=Se,j.cap-=Se,j.ex-=Se,Se+=j.lineHeight});let Ce=0,ce=0;if(F&&(typeof F=="number"?Ce=-F:typeof F=="string"&&(Ce=-K*(F==="left"?0:F==="center"?.5:F==="right"?1:i(F)))),x&&(typeof x=="number"?ce=-x:typeof x=="string"&&(ce=x==="top"?0:x==="top-baseline"?-ve[0].baseline:x==="top-cap"?-ve[0].cap:x==="top-ex"?-ve[0].ex:x==="middle"?Se/2:x==="bottom"?Se:x==="bottom-baseline"?-ve[ve.length-1].baseline:i(x)*Se)),!B){const j=a.getEmbeddingLevels(c,T);V=new Uint16Array(ue),q=new Uint8Array(ue),$=new Float32Array(ue*2),se={},ee=[1/0,1/0,-1/0,-1/0],fe=[],W&&(z=new Float32Array(c.length*4)),P&&(Y=new Uint8Array(ue*3));let he=0,ne=-1,ae=-1,le,be;if(ve.forEach((Q,_e)=>{let{count:J,width:ye}=Q;if(J>0){let me=0;for(let re=J;re--&&Q.glyphAt(re).glyphObj.isWhitespace;)me++;let we=0,Ae=0;if(G==="center")we=(K-ye)/2;else if(G==="right")we=K-ye;else if(G==="justify"&&Q.isSoftWrapped){let re=0;for(let X=J-me;X--;)Q.glyphAt(X).glyphObj.isWhitespace&&re++;Ae=(K-ye)/re}if(Ae||we){let re=0;for(let X=0;X<J;X++){let Ue=Q.glyphAt(X);const xe=Ue.glyphObj;Ue.x+=we+re,Ae!==0&&xe.isWhitespace&&X<J-me&&(re+=Ae,Ue.width+=Ae)}}const Z=a.getReorderSegments(c,j,Q.glyphAt(0).charIndex,Q.glyphAt(Q.count-1).charIndex);for(let re=0;re<Z.length;re++){const[X,Ue]=Z[re];let xe=1/0,H=-1/0;for(let ie=0;ie<J;ie++)if(Q.glyphAt(ie).charIndex>=X){let Fe=ie,ke=ie;for(;ke<J;ke++){let de=Q.glyphAt(ke);if(de.charIndex>Ue)break;ke<J-me&&(xe=Math.min(xe,de.x),H=Math.max(H,de.x+de.width))}for(let de=Fe;de<ke;de++){const Oe=Q.glyphAt(de);Oe.x=H-(Oe.x+Oe.width-xe)}break}}let te;const Me=re=>te=re;for(let re=0;re<J;re++){const X=Q.glyphAt(re);te=X.glyphObj;const Ue=te.index,xe=j.levels[X.charIndex]&1;if(xe){const H=a.getMirroredCharacter(c[X.charIndex]);H&&X.fontData.fontObj.forEachGlyph(H,0,0,Me)}if(W){const{charIndex:H,fontData:ie}=X,Fe=X.x+Ce,ke=X.x+X.width+Ce;z[H*4]=xe?ke:Fe,z[H*4+1]=xe?Fe:ke,z[H*4+2]=Q.baseline+ie.caretBottom+ce,z[H*4+3]=Q.baseline+ie.caretTop+ce;const de=H-ne;de>1&&s(z,ne,de),ne=H}if(P){const{charIndex:H}=X;for(;H>ae;)ae++,P.hasOwnProperty(ae)&&(be=P[ae])}if(!te.isWhitespace&&!te.isEmpty){const H=he++,{fontSizeMult:ie,src:Fe,index:ke}=X.fontData,de=se[Fe]||(se[Fe]={});de[Ue]||(de[Ue]={path:te.path,pathBounds:[te.xMin,te.yMin,te.xMax,te.yMax]});const Oe=X.x+Ce,Ke=X.y+Q.baseline+ce;$[H*2]=Oe,$[H*2+1]=Ke;const We=Oe+te.xMin*ie,ze=Ke+te.yMin*ie,Ne=Oe+te.xMax*ie,Ve=Ke+te.yMax*ie;We<ee[0]&&(ee[0]=We),ze<ee[1]&&(ee[1]=ze),Ne>ee[2]&&(ee[2]=Ne),Ve>ee[3]&&(ee[3]=Ve),H%N===0&&(le={start:H,end:H,rect:[1/0,1/0,-1/0,-1/0]},fe.push(le)),le.end++;const Ge=le.rect;if(We<Ge[0]&&(Ge[0]=We),ze<Ge[1]&&(Ge[1]=ze),Ne>Ge[2]&&(Ge[2]=Ne),Ve>Ge[3]&&(Ge[3]=Ve),V[H]=Ue,q[H]=ke,P){const Qe=H*3;Y[Qe]=be>>16&255,Y[Qe+1]=be>>8&255,Y[Qe+2]=be&255}}}}}),z){const Q=c.length-ne;Q>1&&s(z,ne,Q)}}const Le=[];pe.forEach(({index:j,src:he,unitsPerEm:ne,ascender:ae,descender:le,lineHeight:be,capHeight:Q,xHeight:_e})=>{Le[j]={src:he,unitsPerEm:ne,ascender:ae,descender:le,lineHeight:be,capHeight:Q,xHeight:_e}}),I.typesetting=l()-Ye,A({glyphIds:V,glyphFontIndices:q,glyphPositions:$,glyphData:se,fontData:Le,caretPositions:z,glyphColors:Y,chunkedBounds:fe,fontSize:b,topBaseline:ce+ve[0].baseline,blockBounds:[Ce,ce-Se,Ce+K,ce],visibleBounds:ee,timings:I})})}function r(c,g){o({...c,metricsOnly:!0},y=>{const[_,b,U,m]=y.blockBounds;g({width:U-_,height:m-b})})}function i(c){let g=c.match(/^([\d.]+)%$/),y=g?parseFloat(g[1]):NaN;return isNaN(y)?0:y/100}function s(c,g,y){const _=c[g*4],b=c[g*4+1],U=c[g*4+2],m=c[g*4+3],S=(b-_)/y;for(let w=0;w<y;w++){const k=(g+w)*4;c[k]=_+S*w,c[k+1]=_+S*(w+1),c[k+2]=U,c[k+3]=m}}function l(){return(self.performance||Date).now()}function f(){this.data=[]}const u=["glyphObj","x","y","width","charIndex","fontData"];return f.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/u.length)},glyphAt(c){let g=f.flyweight;return g.data=this.data,g.index=c,g},splitAt(c){let g=new f;return g.data=this.data.splice(c*u.length),g}},f.flyweight=u.reduce((c,g,y,_)=>(Object.defineProperty(c,g,{get(){return this.data[this.index*u.length+y]},set(b){this.data[this.index*u.length+y]=b}}),c),{data:null,index:0}),{typeset:o,measure:r}}const Be=()=>(self.performance||Date).now(),Je=xt();let ut;function rr(v,a,h,d,t,e,n,o,r,i,s=!0){return s?or(v,a,h,d,t,e,n,o,r,i).then(null,l=>(ut||(console.warn("WebGL SDF generation failed, falling back to JS",l),ut=!0),ht(v,a,h,d,t,e,n,o,r,i))):ht(v,a,h,d,t,e,n,o,r,i)}const Xe=[],nr=5;let rt=0;function kt(){const v=Be();for(;Xe.length&&Be()-v<nr;)Xe.shift()();rt=Xe.length?setTimeout(kt,0):0}const or=(...v)=>new Promise((a,h)=>{Xe.push(()=>{const d=Be();try{Je.webgl.generateIntoCanvas(...v),a({timing:Be()-d})}catch(t){h(t)}}),rt||(rt=setTimeout(kt,0))}),ar=4,ir=2e3,ct={};let sr=0;function ht(v,a,h,d,t,e,n,o,r,i){const s="TroikaTextSDFGenerator_JS_"+sr++%ar;let l=ct[s];return l||(l=ct[s]={workerModule:Pe({name:s,workerId:s,dependencies:[xt,Be],init(f,u){const c=f().javascript.generate;return function(...g){const y=u();return{textureData:c(...g),timing:u()-y}}},getTransferables(f){return[f.textureData.buffer]}}),requests:0,idleTimer:null}),l.requests++,clearTimeout(l.idleTimer),l.workerModule(v,a,h,d,t,e).then(({textureData:f,timing:u})=>{const c=Be(),g=new Uint8Array(f.length*4);for(let y=0;y<f.length;y++)g[y*4+i]=f[y];return Je.webglUtils.renderImageData(n,g,o,r,v,a,1<<3-i),u+=Be()-c,--l.requests===0&&(l.idleTimer=setTimeout(()=>{jt(s)},ir)),{timing:u}})}function lr(v){v._warm||(Je.webgl.isSupported(v),v._warm=!0)}const fr=Je.webglUtils.resizeWebGLCanvasWithoutClearing,Ie={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},ur=new nt;let Tt=!1;function Re(){return(self.performance||Date).now()}function Br(v){Tt?console.warn("configureTextBuilder called after first font request; will be ignored."):wt(Ie,v)}const $e=Object.create(null);function Ft(v,a){Tt=!0,v=wt({},v);const h=Re(),{defaultFontURL:d}=Ie,t=[];if(d&&t.push({label:"default",src:dt(d)}),v.font&&t.push({label:"user",src:dt(v.font)}),v.font=t,v.text=""+v.text,v.sdfGlyphSize=v.sdfGlyphSize||Ie.sdfGlyphSize,v.unicodeFontsURL=v.unicodeFontsURL||Ie.unicodeFontsURL,v.colorRanges!=null){let f={};for(let u in v.colorRanges)if(v.colorRanges.hasOwnProperty(u)){let c=v.colorRanges[u];typeof c!="number"&&(c=ur.set(c).getHex()),f[u]=c}v.colorRanges=f}Object.freeze(v);const{textureWidth:e,sdfExponent:n}=Ie,{sdfGlyphSize:o}=v,r=e/o*4;let i=$e[o];if(!i){const f=document.createElement("canvas");f.width=e,f.height=o*256/r,i=$e[o]={glyphCount:0,sdfGlyphSize:o,sdfCanvas:f,sdfTexture:new Ot(f,void 0,void 0,void 0,lt,lt),contextLost:!1,glyphsByFont:new Map},i.sdfTexture.generateMipmaps=!1,cr(i)}const{sdfTexture:s,sdfCanvas:l}=i;dr(v).then(f=>{const{glyphIds:u,glyphFontIndices:c,fontData:g,glyphPositions:y,fontSize:_,timings:b}=f,U=[],m=new Float32Array(u.length*4);let S=0,w=0;const k=Re(),T=g.map(F=>{let x=i.glyphsByFont.get(F.src);return x||i.glyphsByFont.set(F.src,x=new Map),x});u.forEach((F,x)=>{const B=c[x],{src:D,unitsPerEm:M}=g[B];let W=T[B].get(F);if(!W){const{path:I,pathBounds:R}=f.glyphData[D][F],L=Math.max(R[2]-R[0],R[3]-R[1])/o*(Ie.sdfMargin*o+.5),V=i.glyphCount++,q=[R[0]-L,R[1]-L,R[2]+L,R[3]+L];T[B].set(F,W={path:I,atlasIndex:V,sdfViewBox:q}),U.push(W)}const{sdfViewBox:N}=W,P=y[w++],A=y[w++],O=_/M;m[S++]=P+N[0]*O,m[S++]=A+N[1]*O,m[S++]=P+N[2]*O,m[S++]=A+N[3]*O,u[x]=W.atlasIndex}),b.quads=(b.quads||0)+(Re()-k);const G=Re();b.sdf={};const C=l.height,E=Math.ceil(i.glyphCount/r),p=Math.pow(2,Math.ceil(Math.log2(E*o)));p>C&&(console.info(`Increasing SDF texture size ${C}->${p}`),fr(l,e,p),s.dispose()),Promise.all(U.map(F=>Ct(F,i,v.gpuAccelerateSDF).then(({timing:x})=>{b.sdf[F.atlasIndex]=x}))).then(()=>{U.length&&!i.contextLost&&(_t(i),s.needsUpdate=!0),b.sdfTotal=Re()-G,b.total=Re()-h,a(Object.freeze({parameters:v,sdfTexture:s,sdfGlyphSize:o,sdfExponent:n,glyphBounds:m,glyphAtlasIndices:u,glyphColors:f.glyphColors,caretPositions:f.caretPositions,chunkedBounds:f.chunkedBounds,ascender:f.ascender,descender:f.descender,lineHeight:f.lineHeight,capHeight:f.capHeight,xHeight:f.xHeight,topBaseline:f.topBaseline,blockBounds:f.blockBounds,visibleBounds:f.visibleBounds,timings:f.timings}))})}),Promise.resolve().then(()=>{i.contextLost||lr(l)})}function Ct({path:v,atlasIndex:a,sdfViewBox:h},{sdfGlyphSize:d,sdfCanvas:t,contextLost:e},n){if(e)return Promise.resolve({timing:-1});const{textureWidth:o,sdfExponent:r}=Ie,i=Math.max(h[2]-h[0],h[3]-h[1]),s=Math.floor(a/4),l=s%(o/d)*d,f=Math.floor(s/(o/d))*d,u=a%4;return rr(d,d,v,h,i,r,t,l,f,u,n)}function cr(v){const a=v.sdfCanvas;a.addEventListener("webglcontextlost",h=>{console.log("Context Lost",h),h.preventDefault(),v.contextLost=!0}),a.addEventListener("webglcontextrestored",h=>{console.log("Context Restored",h),v.contextLost=!1;const d=[];v.glyphsByFont.forEach(t=>{t.forEach(e=>{d.push(Ct(e,v,!0))})}),Promise.all(d).then(()=>{_t(v),v.sdfTexture.needsUpdate=!0})})}function Rr({font:v,characters:a,sdfGlyphSize:h},d){let t=Array.isArray(a)?a.join(`
`):""+a;Ft({font:v,sdfGlyphSize:h,text:t},d)}function wt(v,a){for(let h in a)a.hasOwnProperty(h)&&(v[h]=a[h]);return v}let je;function dt(v){return je||(je=typeof document>"u"?{}:document.createElement("a")),je.href=v,je.href}function _t(v){if(typeof createImageBitmap!="function"){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:a,sdfTexture:h}=v,{width:d,height:t}=a,e=v.sdfCanvas.getContext("webgl");let n=h.image.data;(!n||n.length!==d*t*4)&&(n=new Uint8Array(d*t*4),h.image={width:d,height:t,data:n},h.flipY=!1,h.isDataTexture=!0),e.readPixels(0,0,d,t,e.RGBA,e.UNSIGNED_BYTE,n)}}const hr=Pe({name:"Typesetter",dependencies:[tr,er,Ht],init(v,a,h){return v(a,h())}}),dr=Pe({name:"Typesetter",dependencies:[hr],init(v){return function(a){return new Promise(h=>{v.typeset(a,h)})}},getTransferables(v){const a=[];for(let h in v)v[h]&&v[h].buffer&&a.push(v[h].buffer);return a}});function Mr(){Object.keys($e).forEach(v=>{const a=$e[v].sdfCanvas,{width:h,height:d}=a;console.log("%c.",`
      background: url(${a.toDataURL()});
      background-size: ${h}px ${d}px;
      color: transparent;
      font-size: 0;
      line-height: ${d}px;
      padding-left: ${h}px;
    `)})}const pt={};function pr(v){let a=pt[v];if(!a){const h=new at(1,1,v,v),d=h.clone(),t=h.attributes,e=d.attributes,n=new Wt,o=t.uv.count;for(let r=0;r<o;r++)e.position.array[r*3]*=-1,e.normal.array[r*3+2]*=-1;["position","normal","uv"].forEach(r=>{n.setAttribute(r,new zt([...t[r].array,...e[r].array],t[r].itemSize))}),n.setIndex([...h.index.array,...d.index.array.map(r=>r+o)]),n.translate(.5,.5,0),a=pt[v]=n}return a}const vr="aTroikaGlyphBounds",vt="aTroikaGlyphIndex",gr="aTroikaGlyphColor";class yr extends It{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new Bt,this.boundingBox=new Rt}computeBoundingSphere(){}computeBoundingBox(){}setSide(a){const h=this.getIndex().count;this.setDrawRange(a===Mt?h/2:0,a===Ut?h:h/2)}set detail(a){if(a!==this._detail){this._detail=a,(typeof a!="number"||a<1)&&(a=1);let h=pr(a);["position","normal","uv"].forEach(d=>{this.attributes[d]=h.attributes[d].clone()}),this.setIndex(h.getIndex().clone())}}get detail(){return this._detail}set curveRadius(a){a!==this._curveRadius&&(this._curveRadius=a,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(a,h,d,t,e){Ze(this,vr,a,4),Ze(this,vt,h,1),Ze(this,gr,e,3),this._blockBounds=d,this._chunkedBounds=t,this.instanceCount=h.length,this._updateBounds()}_updateBounds(){const a=this._blockBounds;if(a){const{curveRadius:h,boundingBox:d}=this;if(h){const{PI:t,floor:e,min:n,max:o,sin:r,cos:i}=Math,s=t/2,l=t*2,f=Math.abs(h),u=a[0]/f,c=a[2]/f,g=e((u+s)/l)!==e((c+s)/l)?-f:n(r(u)*f,r(c)*f),y=e((u-s)/l)!==e((c-s)/l)?f:o(r(u)*f,r(c)*f),_=e((u+t)/l)!==e((c+t)/l)?f*2:o(f-i(u)*f,f-i(c)*f);d.min.set(g,a[1],h<0?-_:0),d.max.set(y,a[3],h<0?0:_)}else d.min.set(a[0],a[1],0),d.max.set(a[2],a[3],0);d.getBoundingSphere(this.boundingSphere)}}applyClipRect(a){let h=this.getAttribute(vt).count,d=this._chunkedBounds;if(d)for(let t=d.length;t--;){h=d[t].end;let e=d[t].rect;if(e[1]<a.w&&e[3]>a.y&&e[0]<a.z&&e[2]>a.x)break}this.instanceCount=h}}function Ze(v,a,h,d){const t=v.getAttribute(a);h?t&&t.array.length===h.length?(t.array.set(h),t.needsUpdate=!0):(v.setAttribute(a,new Et(h,d)),delete v._maxInstanceCount,v.dispose()):t&&v.deleteAttribute(a)}const mr=`
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform vec4 uTroikaTotalBounds;
uniform vec4 uTroikaClipRect;
uniform mat3 uTroikaOrient;
uniform bool uTroikaUseGlyphColors;
uniform float uTroikaDistanceOffset;
uniform float uTroikaBlurRadius;
uniform vec2 uTroikaPositionOffset;
uniform float uTroikaCurveRadius;
attribute vec4 aTroikaGlyphBounds;
attribute float aTroikaGlyphIndex;
attribute vec3 aTroikaGlyphColor;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec3 vTroikaGlyphColor;
varying vec2 vTroikaGlyphDimensions;
`,br=`
vec4 bounds = aTroikaGlyphBounds;
bounds.xz += uTroikaPositionOffset.x;
bounds.yw -= uTroikaPositionOffset.y;

vec4 outlineBounds = vec4(
  bounds.xy - uTroikaDistanceOffset - uTroikaBlurRadius,
  bounds.zw + uTroikaDistanceOffset + uTroikaBlurRadius
);
vec4 clippedBounds = vec4(
  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),
  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)
);

vec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);

position.xy = mix(bounds.xy, bounds.zw, clippedXY);

uv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);

float rad = uTroikaCurveRadius;
if (rad != 0.0) {
  float angle = position.x / rad;
  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);
  normal.xz = vec2(sin(angle), cos(angle));
}
  
position = uTroikaOrient * position;
normal = uTroikaOrient * normal;

vTroikaGlyphUV = clippedXY.xy;
vTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);


float txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;
vec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;
vec2 txStartUV = txUvPerSquare * vec2(
  mod(floor(aTroikaGlyphIndex / 4.0), txCols),
  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)
);
vTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);
vTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);
`,Sr=`
uniform sampler2D uTroikaSDFTexture;
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform float uTroikaSDFExponent;
uniform float uTroikaDistanceOffset;
uniform float uTroikaFillOpacity;
uniform float uTroikaOutlineOpacity;
uniform float uTroikaBlurRadius;
uniform vec3 uTroikaStrokeColor;
uniform float uTroikaStrokeWidth;
uniform float uTroikaStrokeOpacity;
uniform bool uTroikaSDFDebug;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec2 vTroikaGlyphDimensions;

float troikaSdfValueToSignedDistance(float alpha) {
  // Inverse of exponential encoding in webgl-sdf-generator
  
  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);
  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;
  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);
  return signedDist;
}

float troikaGlyphUvToSdfValue(vec2 glyphUV) {
  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);
  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);
  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1
  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;
}

float troikaGlyphUvToDistance(vec2 uv) {
  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));
}

float troikaGetAADist() {
  
  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300
  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;
  #else
  return vTroikaGlyphDimensions.x / 64.0;
  #endif
}

float troikaGetFragDistValue() {
  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);
  float distance = troikaGlyphUvToDistance(clampedGlyphUV);
 
  // Extrapolate distance when outside bounds:
  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : 
    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);

  

  return distance;
}

float troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {
  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)
  float alpha = step(-distanceOffset, -distance);
  #else

  float alpha = smoothstep(
    distanceOffset + aaDist,
    distanceOffset - aaDist,
    distance
  );
  #endif

  return alpha;
}
`,Ur=`
float aaDist = troikaGetAADist();
float fragDistance = troikaGetFragDistValue();
float edgeAlpha = uTroikaSDFDebug ?
  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :
  troikaGetEdgeAlpha(fragDistance, uTroikaDistanceOffset, max(aaDist, uTroikaBlurRadius));

#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)
vec4 fillRGBA = gl_FragColor;
fillRGBA.a *= uTroikaFillOpacity;
vec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);
if (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;
gl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(
  -uTroikaStrokeWidth - aaDist,
  -uTroikaStrokeWidth + aaDist,
  fragDistance
));
gl_FragColor.a *= edgeAlpha;
#endif

if (edgeAlpha == 0.0) {
  discard;
}
`;function xr(v){const a=Xt(v,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new qe},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new ft(0,0,0,0)},uTroikaClipRect:{value:new ft(0,0,0,0)},uTroikaDistanceOffset:{value:0},uTroikaOutlineOpacity:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new qe},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new nt},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new Pt},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:mr,vertexTransform:br,fragmentDefs:Sr,fragmentColorTransform:Ur,customRewriter({vertexShader:h,fragmentShader:d}){let t=/\buniform\s+vec3\s+diffuse\b/;return t.test(d)&&(d=d.replace(t,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),t.test(h)||(h=h.replace(qt,`uniform vec3 diffuse;
$&
vTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;
`))),{vertexShader:h,fragmentShader:d}}});return a.transparent=!0,Object.defineProperties(a,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),a}const st=new Nt({color:16777215,side:Ut,transparent:!0}),gt=8421504,yt=new Vt,He=new it,et=new it,Ee=[],kr=new it,tt="+x+y";function mt(v){return Array.isArray(v)?v[0]:v}let Dt=()=>{const v=new ot(new at(1,1),st);return Dt=()=>v,v},At=()=>{const v=new ot(new at(1,1,32,1),st);return At=()=>v,v};const Tr={type:"syncstart"},Fr={type:"synccomplete"},Gt=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],Cr=Gt.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class wr extends ot{constructor(){const a=new yr;super(a,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=gt,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=tt,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(a){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(a):(this._isSyncing=!0,this.dispatchEvent(Tr),Ft({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},h=>{this._isSyncing=!1,this._textRenderInfo=h,this.geometry.updateGlyphs(h.glyphBounds,h.glyphAtlasIndices,h.blockBounds,h.chunkedBounds,h.glyphColors);const d=this._queuedSyncs;d&&(this._queuedSyncs=null,this._needsSync=!0,this.sync(()=>{d.forEach(t=>t&&t())})),this.dispatchEvent(Fr),a&&a()})))}onBeforeRender(a,h,d,t,e,n){this.sync(),e.isTroikaTextMaterial&&this._prepareForRender(e),e._hadOwnSide=e.hasOwnProperty("side"),this.geometry.setSide(e._actualSide=e.side),e.side=Lt}onAfterRender(a,h,d,t,e,n){e._hadOwnSide?e.side=e._actualSide:delete e.side}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}get material(){let a=this._derivedMaterial;const h=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=st.clone());if((!a||a.baseMaterial!==h)&&(a=this._derivedMaterial=xr(h),h.addEventListener("dispose",function d(){h.removeEventListener("dispose",d),a.dispose()})),this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY){let d=a._outlineMtl;return d||(d=a._outlineMtl=Object.create(a,{id:{value:a.id+.1}}),d.isTextOutlineMaterial=!0,d.depthWrite=!1,d.map=null,a.addEventListener("dispose",function t(){a.removeEventListener("dispose",t),d.dispose()})),[d,a]}else return a}set material(a){a&&a.isTroikaTextMaterial?(this._derivedMaterial=a,this._baseMaterial=a.baseMaterial):this._baseMaterial=a}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(a){this.geometry.detail=a}get curveRadius(){return this.geometry.curveRadius}set curveRadius(a){this.geometry.curveRadius=a}get customDepthMaterial(){return mt(this.material).getDepthMaterial()}get customDistanceMaterial(){return mt(this.material).getDistanceMaterial()}_prepareForRender(a){const h=a.isTextOutlineMaterial,d=a.uniforms,t=this.textRenderInfo;if(t){const{sdfTexture:o,blockBounds:r}=t;d.uTroikaSDFTexture.value=o,d.uTroikaSDFTextureSize.value.set(o.image.width,o.image.height),d.uTroikaSDFGlyphSize.value=t.sdfGlyphSize,d.uTroikaSDFExponent.value=t.sdfExponent,d.uTroikaTotalBounds.value.fromArray(r),d.uTroikaUseGlyphColors.value=!h&&!!t.glyphColors;let i=0,s=0,l=0,f,u,c,g=0,y=0;if(h){let{outlineWidth:b,outlineOffsetX:U,outlineOffsetY:m,outlineBlur:S,outlineOpacity:w}=this;i=this._parsePercent(b)||0,s=Math.max(0,this._parsePercent(S)||0),f=w,g=this._parsePercent(U)||0,y=this._parsePercent(m)||0}else l=Math.max(0,this._parsePercent(this.strokeWidth)||0),l&&(c=this.strokeColor,d.uTroikaStrokeColor.value.set(c??gt),u=this.strokeOpacity,u==null&&(u=1)),f=this.fillOpacity;d.uTroikaDistanceOffset.value=i,d.uTroikaPositionOffset.value.set(g,y),d.uTroikaBlurRadius.value=s,d.uTroikaStrokeWidth.value=l,d.uTroikaStrokeOpacity.value=u,d.uTroikaFillOpacity.value=f??1,d.uTroikaCurveRadius.value=this.curveRadius||0;let _=this.clipRect;if(_&&Array.isArray(_)&&_.length===4)d.uTroikaClipRect.value.fromArray(_);else{const b=(this.fontSize||.1)*100;d.uTroikaClipRect.value.set(r[0]-b,r[1]-b,r[2]+b,r[3]+b)}this.geometry.applyClipRect(d.uTroikaClipRect.value)}d.uTroikaSDFDebug.value=!!this.debugSDF,a.polygonOffset=!!this.depthOffset,a.polygonOffsetFactor=a.polygonOffsetUnits=this.depthOffset||0;const e=h?this.outlineColor||0:this.color;if(e==null)delete a.color;else{const o=a.hasOwnProperty("color")?a.color:a.color=new nt;(e!==o._input||typeof e=="object")&&o.set(o._input=e)}let n=this.orientation||tt;if(n!==a._orientation){let o=d.uTroikaOrient.value;n=n.replace(/[^-+xyz]/g,"");let r=n!==tt&&n.match(/^([-+])([xyz])([-+])([xyz])$/);if(r){let[,i,s,l,f]=r;He.set(0,0,0)[s]=i==="-"?1:-1,et.set(0,0,0)[f]=l==="-"?-1:1,yt.lookAt(kr,He.cross(et),et),o.setFromMatrix4(yt)}else o.identity();a._orientation=n}}_parsePercent(a){if(typeof a=="string"){let h=a.match(/^(-?[\d.]+)%$/),d=h?parseFloat(h[1]):NaN;a=(isNaN(d)?0:d/100)*this.fontSize}return a}localPositionToTextCoords(a,h=new qe){h.copy(a);const d=this.curveRadius;return d&&(h.x=Math.atan2(a.x,Math.abs(d)-Math.abs(a.z))*Math.abs(d)),h}worldPositionToTextCoords(a,h=new qe){return He.copy(a),this.localPositionToTextCoords(this.worldToLocal(He),h)}raycast(a,h){const{textRenderInfo:d,curveRadius:t}=this;if(d){const e=d.blockBounds,n=t?At():Dt(),o=n.geometry,{position:r,uv:i}=o.attributes;for(let s=0;s<i.count;s++){let l=e[0]+i.getX(s)*(e[2]-e[0]);const f=e[1]+i.getY(s)*(e[3]-e[1]);let u=0;t&&(u=t-Math.cos(l/t)*t,l=Math.sin(l/t)*t),r.setXYZ(s,l,f,u)}o.boundingSphere=this.geometry.boundingSphere,o.boundingBox=this.geometry.boundingBox,n.matrixWorld=this.matrixWorld,n.material.side=this.material.side,Ee.length=0,n.raycast(a,Ee);for(let s=0;s<Ee.length;s++)Ee[s].object=this,h.push(Ee[s])}}copy(a){const h=this.geometry;return super.copy(a),this.geometry=h,Cr.forEach(d=>{this[d]=a[d]}),this}clone(){return new this.constructor().copy(this)}}Gt.forEach(v=>{const a="_private_"+v;Object.defineProperty(wr.prototype,v,{get(){return this[a]},set(h){h!==this[a]&&(this[a]=h,this._needsSync=!0)}})});function Er(v,a,h){let d=null;const t=_r(v);let e=null;return t.forEach(n=>{(!e||Math.abs(h-(n.top+n.bottom)/2)<Math.abs(h-(e.top+e.bottom)/2))&&(e=n)}),e.carets.forEach(n=>{(!d||Math.abs(a-n.x)<Math.abs(a-d.x))&&(d=n)}),d}const bt=new WeakMap;function Pr(v,a,h){let d;if(v){let t=bt.get(v);if(t&&t.start===a&&t.end===h)return t.rects;const{caretPositions:e}=v;if(h<a){const o=a;a=h,h=o}a=Math.max(a,0),h=Math.min(h,e.length+1),d=[];let n=null;for(let o=a;o<h;o++){const r=e[o*4],i=e[o*4+1],s=Math.min(r,i),l=Math.max(r,i),f=e[o*4+2],u=e[o*4+3];(!n||f!==n.bottom||u!==n.top||s>n.right||l<n.left)&&(n={left:1/0,right:-1/0,bottom:f,top:u},d.push(n)),n.left=Math.min(s,n.left),n.right=Math.max(l,n.right)}d.sort((o,r)=>r.bottom-o.bottom||o.left-r.left);for(let o=d.length-1;o-- >0;){const r=d[o],i=d[o+1];r.bottom===i.bottom&&r.top===i.top&&r.left<=i.right&&r.right>=i.left&&(i.left=Math.min(i.left,r.left),i.right=Math.max(i.right,r.right),d.splice(o,1))}bt.set(v,{start:a,end:h,rects:d})}return d}const St=new WeakMap;function _r(v){let a=St.get(v);if(!a){a=[];const{caretPositions:h}=v;let d;const t=(n,o,r,i)=>{(!d||r<(d.top+d.bottom)/2)&&a.push(d={bottom:o,top:r,carets:[]}),r>d.top&&(d.top=r),o<d.bottom&&(d.bottom=o),d.carets.push({x:n,y:o,height:r-o,charIndex:i})};let e=0;for(;e<h.length;e+=4)t(h[e],h[e+2],h[e+3],e/4);t(h[e-3],h[e-2],h[e-1],e/4)}return St.set(v,a),a}export{yr as GlyphsGeometry,wr as Text,Br as configureTextBuilder,xr as createTextDerivedMaterial,Mr as dumpSDFTextures,er as fontResolverWorkerModule,Er as getCaretAtPoint,Pr as getSelectionRects,Ft as getTextRenderInfo,Rr as preloadFont,hr as typesetterWorkerModule};
