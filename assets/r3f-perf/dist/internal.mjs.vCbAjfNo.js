import{M as w}from"../../three/build/three.module.js.mjdRT5l4.js";import{s as l,g as f}from"./store.mjs.WTcb4_d4.js";const h={value:0,fpsLimit:60,isOverLimit:0},u=m=>(m==null?void 0:m.reduce((s,t)=>s+t,0))/m.length;class I{constructor(s={}){this.names=[""],this.finished=[],this.paused=!1,this.overClock=!1,this.queryHasResult=!1,this.queryCreated=!1,this.isWebGL2=!0,this.memAccums=[],this.gpuAccums=[],this.activeAccums=[],this.logsAccums={mem:[],gpu:[],cpu:[],fps:[],fpsFixed:[]},this.fpsChart=[],this.gpuChart=[],this.cpuChart=[],this.memChart=[],this.paramLogger=()=>{},this.glFinish=()=>{},this.chartLogger=()=>{},this.chartLen=60,this.logsPerSecond=10,this.maxMemory=1500,this.chartHz=10,this.startCpuProfiling=!1,this.lastCalculateFixed=0,this.chartFrame=0,this.gpuTimeProcess=0,this.chartTime=0,this.activeQueries=0,this.circularId=0,this.detected=0,this.frameId=0,this.rafId=0,this.idleCbId=0,this.checkQueryId=0,this.uuid=void 0,this.currentCpu=0,this.currentMem=0,this.paramFrame=0,this.paramTime=0,this.now=()=>{},this.t0=0,window.GLPerf=window.GLPerf||{},Object.assign(this,s),this.fpsChart=new Array(this.chartLen).fill(0),this.gpuChart=new Array(this.chartLen).fill(0),this.cpuChart=new Array(this.chartLen).fill(0),this.memChart=new Array(this.chartLen).fill(0),this.now=()=>window.performance&&window.performance.now?window.performance.now():Date.now(),this.initGpu(),this.is120hz()}initGpu(){this.uuid=w.generateUUID(),this.gl&&(this.isWebGL2=!0,this.extension||(this.extension=this.gl.getExtension("EXT_disjoint_timer_query_webgl2")),this.extension===null&&(this.isWebGL2=!1))}is120hz(){let s=0;const t=i=>{++s<20?this.rafId=window.requestAnimationFrame(t):(this.detected=Math.ceil(1e3*s/(i-this.t0)/70),window.cancelAnimationFrame(this.rafId)),this.t0||(this.t0=i)};this.rafId=window.requestAnimationFrame(t)}addUI(s){this.names.indexOf(s)===-1&&(this.names.push(s),this.gpuAccums.push(0),this.activeAccums.push(!1))}nextFps(s){const t=16.666666666666668,i=t-s.timeRemaining(),e=t*h.fpsLimit/10/i;e<0||(h.value=e,h.isOverLimit<25?h.isOverLimit++:l({overclockingFps:!0}))}nextFrame(s){this.frameId++;const t=s||this.now();let i=t-this.paramTime,e=0;if(this.frameId<=1)this.paramFrame=this.frameId,this.paramTime=t;else if(t>=this.paramTime){this.maxMemory=window.performance.memory?window.performance.memory.jsHeapSizeLimit/1048576:0;const r=this.frameId-this.paramFrame,a=r*1e3/i,c=f().overclockingFps?h.value:a;if(e=this.isWebGL2?this.gpuAccums[0]:this.gpuAccums[0]/i,this.isWebGL2?this.gpuAccums[0]=0:Promise.all(this.finished).then(()=>{this.gpuAccums[0]=0,this.finished=[]}),this.currentMem=Math.round(window.performance&&window.performance.memory?window.performance.memory.usedJSHeapSize/1048576:0),window.performance&&this.startCpuProfiling){window.performance.mark("cpu-finished");const n=performance.measure("cpu-duration","cpu-started","cpu-finished");this.currentCpu=n.duration,this.logsAccums.cpu.push(this.currentCpu),this.startCpuProfiling=!1}this.logsAccums.mem.push(this.currentMem),this.logsAccums.fpsFixed.push(a),this.logsAccums.fps.push(c),this.logsAccums.gpu.push(e),this.overClock&&typeof window.requestIdleCallback<"u"&&(h.isOverLimit>0&&c>a?h.isOverLimit--:f().overclockingFps&&l({overclockingFps:!1})),t>=this.paramTime+1e3/this.logsPerSecond&&(this.paramLogger({cpu:u(this.logsAccums.cpu),gpu:u(this.logsAccums.gpu),mem:u(this.logsAccums.mem),fps:u(this.logsAccums.fps),duration:Math.round(i),maxMemory:this.maxMemory,frameCount:r}),this.logsAccums.mem=[],this.logsAccums.fps=[],this.logsAccums.gpu=[],this.logsAccums.cpu=[],this.paramFrame=this.frameId,this.paramTime=t),this.overClock&&t-this.lastCalculateFixed>=2*1e3&&(this.lastCalculateFixed=s,h.fpsLimit=Math.round(u(this.logsAccums.fpsFixed)/10)*100,l({fpsLimit:h.fpsLimit/10}),this.logsAccums.fpsFixed=[],this.paramFrame=this.frameId,this.paramTime=t)}if(!this.detected||!this.chartFrame)this.chartFrame=this.frameId,this.chartTime=t,this.circularId=0;else{const r=t-this.chartTime;let a=this.chartHz*r/1e3;for(;--a>0&&this.detected;){const n=(this.frameId-this.chartFrame)/r*1e3,o=f().overclockingFps?h.value:n;this.fpsChart[this.circularId%this.chartLen]=o;const d=1e3/this.currentMem,g=this.currentCpu,A=(this.isWebGL2?this.gpuAccums[1]*2:Math.round(this.gpuAccums[1]/i*100))+4;A>0&&(this.gpuChart[this.circularId%this.chartLen]=A),g>0&&(this.cpuChart[this.circularId%this.chartLen]=g),d>0&&(this.memChart[this.circularId%this.chartLen]=d);for(let p=0;p<this.names.length;p++)this.chartLogger({i:p,data:{fps:this.fpsChart,gpu:this.gpuChart,cpu:this.cpuChart,mem:this.memChart},circularId:this.circularId});this.circularId++,this.chartFrame=this.frameId,this.chartTime=t}}}startGpu(){const s=this.gl,t=this.extension;if(!(!s||!t)&&this.isWebGL2){let i=!1,e,r;if(this.query){this.queryHasResult=!1;let a=this.query;if(i=s.getQueryParameter(a,s.QUERY_RESULT_AVAILABLE),e=s.getParameter(t.GPU_DISJOINT_EXT),i&&!e){r=s.getQueryParameter(this.query,s.QUERY_RESULT);const c=r*1e-6;(i||e)&&(s.deleteQuery(this.query),a=null),i&&c>0&&(e||this.activeAccums.forEach((n,o)=>{this.gpuAccums[o]=c}))}}(i||!this.query)&&(this.queryCreated=!0,this.query=s.createQuery(),s.beginQuery(t.TIME_ELAPSED_EXT,this.query))}}endGpu(){const s=this.extension,t=this.gl;this.isWebGL2&&this.queryCreated&&t.getQuery(s.TIME_ELAPSED_EXT,t.CURRENT_QUERY)&&t.endQuery(s.TIME_ELAPSED_EXT)}begin(s){this.startGpu(),this.updateAccums(s)}end(s){this.endGpu(),this.updateAccums(s)}updateAccums(s){let t=this.names.indexOf(s);t===-1&&(t=this.names.length,this.addUI(s));const i=this.now();this.activeAccums[t]=!this.activeAccums[t],this.t0=i}}export{I as G,h as o};
//# sourceMappingURL=internal.mjs.vCbAjfNo.js.map
