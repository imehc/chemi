import{r as M}from"../../../react/index.js.4247Uq6c.js";import{G as U,o as I}from"../internal.mjs.gD9EFVWZ.js";import{O as x,d as k,a as D,av as z}from"../../../three/build/three.module.js.ZP5wlr6b.js";import{c as G}from"../helpers/countGeoDrawCalls.mjs.mv8ZuZCr.js";import{s as f,g as h}from"../store.mjs.WTcb4_d4.js";import{e as O}from"../../../@utsubo/events/dist/vanilla.mjs.sGgSxmCn.js";import{u as S,b as N,d as B,n as K}from"../../../@react-three/fiber/dist/index-db8af450.esm.js.eaJ-IQWK.js";const V=x.prototype.updateMatrixWorld,H=x.prototype.updateWorldMatrix,C=x.prototype.updateMatrix,L=["calls","triangles","points","lines"],T=["gpu","cpu","mem","fps"];let R={value:0},F={value:0};const q=t=>{let u=""+t;return u=u.match("^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"),u!==null},W=(t,u)=>{t.defines||(t.defines={}),t.defines&&!t.defines.muiPerf&&(t.defines=Object.assign(t.defines||{},{muiPerf:t.uuid}));const r=t.uuid;return u[r]||(u[r]={meshes:{},material:t},t.needsUpdate=!0),t.needsUpdate=!1,r},Q=t=>t==="muiPerf",te=({overClock:t,logsPerSecond:u,chart:r,deepAnalyze:_,matrixUpdate:b})=>{const{gl:i,scene:A}=S();f({gl:i,scene:A});const n=M.useMemo(()=>{const l=new U({trackGPU:!0,overClock:t,chartLen:r?r.length:120,chartHz:r?r.hz:60,logsPerSecond:u||10,gl:i.getContext(),chartLogger:e=>{f({chart:e})},paramLogger:e=>{const a={maxMemory:e.maxMemory,gpu:e.gpu,cpu:e.cpu,mem:e.mem,fps:e.fps,totalTime:e.duration,frameCount:e.frameCount};f({log:a});const{accumulated:s}=h(),m=i.info.render;s.totalFrames++,s.gl.calls+=m.calls,s.gl.triangles+=m.triangles,s.gl.points+=m.points,s.gl.lines+=m.lines,s.log.gpu+=e.gpu,s.log.cpu+=e.cpu,s.log.mem+=e.mem,s.log.fps+=e.fps;for(let g=0;g<L.length;g++){const v=L[g],E=m[v];E>s.max.gl[v]&&(s.max.gl[v]=E)}for(let g=0;g<T.length;g++){const v=T[g],E=e[v];E>s.max.log[v]&&(s.max.log[v]=E)}f({accumulated:s}),O("log",[a,i])}}),o=i.getContext();let y=null,d=null;const P=o.getExtension("WEBGL_debug_renderer_info"),p=o.getParameter(o.VERSION);P!=null&&(y=o.getParameter(P.UNMASKED_RENDERER_WEBGL),d=o.getParameter(P.UNMASKED_VENDOR_WEBGL)),d||(d="Unknown vendor"),y||(y=o.getParameter(o.RENDERER)),f({startTime:window.performance.now(),infos:{version:p,renderer:y,vendor:d}});const c=new Map,w=new Map;return Object.defineProperty(k.prototype,"onBeforeRender",{get(){return(...e)=>{var a;l&&l.begin("profiler"),(a=c.get(this))==null||a(...e)}},set(e){c.set(this,e)},configurable:!0}),Object.defineProperty(k.prototype,"onAfterRender",{get(){return(...e)=>{var a;l&&l.end("profiler"),(a=w.get(this))==null||a(...e)}},set(e){w.set(this,e)},configurable:!0}),l},[]);return M.useEffect(()=>{n&&(n.overClock=t||!1,t===!1&&(f({overclockingFps:!1}),I.value=0,I.isOverLimit=0),n.chartHz=(r==null?void 0:r.hz)||60,n.chartLen=(r==null?void 0:r.length)||120)},[t,n,r==null?void 0:r.length,r==null?void 0:r.hz]),M.useEffect(()=>{b&&(x.prototype.updateMatrixWorld=function(){(this.matrixWorldNeedsUpdate||arguments[0])&&R.value++,V.apply(this,arguments)},x.prototype.updateWorldMatrix=function(){R.value++,H.apply(this,arguments)},x.prototype.updateMatrix=function(){F.value++,C.apply(this,arguments)}),i.info.autoReset=!1;let l=null,o=null;if(i.info)return l=N(function(){h().paused&&f({paused:!1}),window.performance&&(window.performance.mark("cpu-started"),n.startCpuProfiling=!0),F.value-=1,R.value=0,F.value=0,i.info&&i.info.reset()}),o=B(function(){var d,P;if(n&&!n.paused&&(n.nextFrame(window.performance.now()),t&&typeof window.requestIdleCallback<"u"&&(n.idleCbId=requestIdleCallback(n.nextFps))),_){const p={},c=new Map;A.traverse(function(e){if((e instanceof D||e instanceof z)&&e.material){let a=e.material.uuid;Array.isArray(e.material)&&e.material.length>1?a=W(e.material[1],p):a=W(e.material,p),p[a].meshes[e.uuid]=e}}),(P=(d=i==null?void 0:i.info)==null?void 0:d.programs)==null||P.forEach(w=>{const e=w.cacheKey.split(","),a=e[e.findIndex(Q)+1];if(q(a)&&p[a]){const{material:s,meshes:m}=p[a];c.set(a,{program:w,material:s,meshes:m,drawCounts:{total:0,type:"triangle",data:[]},expand:!1,visible:!0})}}),c.size!==h().programs.size&&(G(c),f({programs:c,triggerProgramsUpdate:h().triggerProgramsUpdate++}))}}),()=>{n&&(typeof window.cancelIdleCallback<"u"&&window.cancelIdleCallback(n.idleCbId),window.cancelAnimationFrame(n.rafId),window.cancelAnimationFrame(n.checkQueryId)),b&&(x.prototype.updateMatrixWorld=C),l(),o()}},[n,i,r,b]),M.useEffect(()=>{const l=K(function(){return n&&(n.paused=!0,F.value=0,R.value=0,f({paused:!0,log:{maxMemory:0,gpu:0,mem:0,cpu:0,fps:0,totalTime:0,frameCount:0}})),!1});return()=>{l()}},[]),null};export{te as P,R as a,F as m};
//# sourceMappingURL=PerfHeadless.mjs.nt2UXgp3.js.map
