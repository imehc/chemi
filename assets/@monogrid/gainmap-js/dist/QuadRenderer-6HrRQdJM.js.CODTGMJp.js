import{R as b,L as d,C as h,S as D,O as I,H as F,F as R,M,P as A,W as B,U as x,a as U,D as C,b as E,c as L,T as S,I as q,d as G,B as j,e as W,f as z,g as H}from"../../../three/build/three.module.js.CElijN_X.js";const P=(o,e,r)=>{let t;switch(o){case z:t=new Uint8ClampedArray(e*r*4);break;case F:t=new Uint16Array(e*r*4);break;case W:t=new Uint32Array(e*r*4);break;case j:t=new Int8Array(e*r*4);break;case G:t=new Int16Array(e*r*4);break;case q:t=new Int32Array(e*r*4);break;case R:t=new Float32Array(e*r*4);break;default:throw new Error("Unsupported data type")}return t};let l;const V=(o,e,r,t)=>{if(l!==void 0)return l;const i=new B(1,1,t);e.setRenderTarget(i);const a=new M(new A,new H({color:16777215}));e.render(a,r),e.setRenderTarget(null);const s=P(o,i.width,i.height);return e.readRenderTargetPixels(i,0,0,i.width,i.height,s),i.dispose(),a.geometry.dispose(),a.material.dispose(),l=s[0]!==0,l};class k{constructor(e){var r,t,i,a,s,_,u,g,p,c,m,T,f,w,v,y;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(n){throw this._renderer.setRenderTarget(null),n}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;const O={format:b,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:((r=e.renderTargetOptions)===null||r===void 0?void 0:r.anisotropy)!==void 0?(t=e.renderTargetOptions)===null||t===void 0?void 0:t.anisotropy:1,generateMipmaps:((i=e.renderTargetOptions)===null||i===void 0?void 0:i.generateMipmaps)!==void 0?(a=e.renderTargetOptions)===null||a===void 0?void 0:a.generateMipmaps:!1,magFilter:((s=e.renderTargetOptions)===null||s===void 0?void 0:s.magFilter)!==void 0?(_=e.renderTargetOptions)===null||_===void 0?void 0:_.magFilter:d,minFilter:((u=e.renderTargetOptions)===null||u===void 0?void 0:u.minFilter)!==void 0?(g=e.renderTargetOptions)===null||g===void 0?void 0:g.minFilter:d,samples:((p=e.renderTargetOptions)===null||p===void 0?void 0:p.samples)!==void 0?(c=e.renderTargetOptions)===null||c===void 0?void 0:c.samples:void 0,wrapS:((m=e.renderTargetOptions)===null||m===void 0?void 0:m.wrapS)!==void 0?(T=e.renderTargetOptions)===null||T===void 0?void 0:T.wrapS:h,wrapT:((f=e.renderTargetOptions)===null||f===void 0?void 0:f.wrapT)!==void 0?(w=e.renderTargetOptions)===null||w===void 0?void 0:w.wrapT:h};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=k.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new D,this._camera=new I,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!V(this._type,this._renderer,this._camera,O)){let n;switch(this._type){case F:n=this._renderer.extensions.has("EXT_color_buffer_float")?R:void 0;break}n!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${R}`),this._type=n):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new M(new A,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new B(this.width,this.height,O),this._renderTarget.texture.mapping=((v=e.renderTargetOptions)===null||v===void 0?void 0:v.mapping)!==void 0?(y=e.renderTargetOptions)===null||y===void 0?void 0:y.mapping:x}static instantiateRenderer(){const e=new U;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const e=P(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){const r=new C(this.toArray(),this.width,this.height,b,this._type,(e==null?void 0:e.mapping)||x,(e==null?void 0:e.wrapS)||h,(e==null?void 0:e.wrapT)||h,(e==null?void 0:e.magFilter)||d,(e==null?void 0:e.minFilter)||d,(e==null?void 0:e.anisotropy)||1,E);return r.generateMipmaps=(e==null?void 0:e.generateMipmaps)!==void 0?e==null?void 0:e.generateMipmaps:!1,r}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof L&&Object.values(this.material.uniforms).forEach(r=>{r.value instanceof S&&r.value.dispose()}),Object.values(this.material).forEach(r=>{r instanceof S&&r.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}export{k as Q};
