import{r as s}from"../../../react/index.js.IuPGg7Py.js";import{V as u,Q as M,m as b,n as A}from"../../../three/build/three.module.js.jQmR1wrA.js";import{u as Z,a as q}from"../../fiber/dist/index-ba8afaa4.esm.js.CC8UC62r.js";var i=function(c){return c[c.NONE=0]="NONE",c[c.START=1]="START",c[c.ACTIVE=2]="ACTIVE",c}(i||{});const h=c=>c&&c.isOrthographicCamera,D=c=>c&&c.isBox3,L=c=>1-Math.exp(-5*c)+.007*c,F=s.createContext(null);function G({children:c,maxDuration:O=1,margin:w=1.2,observe:E,fit:v,clip:C,interpolateFunc:U=L,onFit:N}){const S=s.useRef(null),{camera:t,size:V,invalidate:R}=Z(),a=Z(f=>f.controls),z=s.useRef(N);z.current=N;const l=s.useRef({camPos:new u,camRot:new M,camZoom:1}),e=s.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),d=s.useRef(i.NONE),p=s.useRef(0),[n]=s.useState(()=>new b),y=s.useMemo(()=>{function f(){const r=n.getSize(new u),o=n.getCenter(new u),m=Math.max(r.x,r.y,r.z),x=h(t)?m*4:m/(2*Math.atan(Math.PI*t.fov/360)),g=h(t)?m*4:x/t.aspect,P=w*Math.max(x,g);return{box:n,size:r,center:o,distance:P}}return{getSize:f,refresh(r){if(D(r))n.copy(r);else{const o=r||S.current;if(!o)return this;o.updateWorldMatrix(!0,!0),n.setFromObject(o)}if(n.isEmpty()){const o=t.position.length()||10;n.setFromCenterAndSize(new u,new u(o,o,o))}return l.current.camPos.copy(t.position),l.current.camRot.copy(t.quaternion),h(t)&&(l.current.camZoom=t.zoom),e.current.camPos=void 0,e.current.camRot=void 0,e.current.camZoom=void 0,e.current.camUp=void 0,e.current.target=void 0,this},reset(){const{center:r,distance:o}=f(),m=t.position.clone().sub(r).normalize();e.current.camPos=r.clone().addScaledVector(m,o),e.current.target=r.clone();const x=new A().lookAt(e.current.camPos,e.current.target,t.up);return e.current.camRot=new M().setFromRotationMatrix(x),d.current=i.START,p.current=0,this},moveTo(r){return e.current.camPos=Array.isArray(r)?new u(...r):r.clone(),d.current=i.START,p.current=0,this},lookAt({target:r,up:o}){e.current.target=Array.isArray(r)?new u(...r):r.clone(),o?e.current.camUp=Array.isArray(o)?new u(...o):o.clone():e.current.camUp=t.up.clone();const m=new A().lookAt(e.current.camPos||t.position,e.current.target,e.current.camUp);return e.current.camRot=new M().setFromRotationMatrix(m),d.current=i.START,p.current=0,this},to({position:r,target:o}){return this.moveTo(r).lookAt({target:o})},fit(){if(!h(t))return this.reset();let r=0,o=0;const m=[new u(n.min.x,n.min.y,n.min.z),new u(n.min.x,n.max.y,n.min.z),new u(n.min.x,n.min.y,n.max.z),new u(n.min.x,n.max.y,n.max.z),new u(n.max.x,n.max.y,n.max.z),new u(n.max.x,n.max.y,n.min.z),new u(n.max.x,n.min.y,n.max.z),new u(n.max.x,n.min.y,n.min.z)],x=e.current.camPos||t.position,g=e.current.target||(a==null?void 0:a.target),P=e.current.camUp||t.up,k=g?new A().lookAt(x,g,P).setPosition(x).invert():t.matrixWorldInverse;for(const T of m)T.applyMatrix4(k),r=Math.max(r,Math.abs(T.y)),o=Math.max(o,Math.abs(T.x));r*=2,o*=2;const I=(t.top-t.bottom)/r,B=(t.right-t.left)/o;return e.current.camZoom=Math.min(I,B)/w,d.current=i.START,p.current=0,z.current&&z.current(this.getSize()),this},clip(){const{distance:r}=f();return t.near=r/100,t.far=r*100,t.updateProjectionMatrix(),a&&(a.maxDistance=r*10,a.update()),R(),this}}},[n,t,a,w,R]);s.useLayoutEffect(()=>{if(a){const f=()=>{if(a&&e.current.target&&d.current!==i.NONE){const r=new u().setFromMatrixColumn(t.matrix,2),o=l.current.camPos.distanceTo(a.target),m=(e.current.camPos||l.current.camPos).distanceTo(e.current.target),x=(1-p.current)*o+p.current*m;a.target.copy(t.position).addScaledVector(r,-x),a.update()}d.current=i.NONE};return a.addEventListener("start",f),()=>a.removeEventListener("start",f)}},[a]);const W=s.useRef(0);return s.useLayoutEffect(()=>{(E||W.current++===0)&&(y.refresh(),v&&y.reset().fit(),C&&y.clip())},[V,C,v,E,t,a]),q((f,r)=>{if(d.current===i.START)d.current=i.ACTIVE,R();else if(d.current===i.ACTIVE){if(p.current+=r/O,p.current>=1)e.current.camPos&&t.position.copy(e.current.camPos),e.current.camRot&&t.quaternion.copy(e.current.camRot),e.current.camUp&&t.up.copy(e.current.camUp),e.current.camZoom&&h(t)&&(t.zoom=e.current.camZoom),t.updateMatrixWorld(),t.updateProjectionMatrix(),a&&e.current.target&&(a.target.copy(e.current.target),a.update()),d.current=i.NONE;else{const o=U(p.current);e.current.camPos&&t.position.lerpVectors(l.current.camPos,e.current.camPos,o),e.current.camRot&&t.quaternion.slerpQuaternions(l.current.camRot,e.current.camRot,o),e.current.camUp&&t.up.set(0,1,0).applyQuaternion(t.quaternion),e.current.camZoom&&h(t)&&(t.zoom=(1-o)*l.current.camZoom+o*e.current.camZoom),t.updateMatrixWorld(),t.updateProjectionMatrix()}R()}}),s.createElement("group",{ref:S},s.createElement(F.Provider,{value:y},c))}function J(){return s.useContext(F)}export{G as B,J as u};
