import{j as M}from"../../../react/jsx-runtime.js.Cm6upDnr.js";import{_ as G,H as U}from"../../../three/build/three.module.js.jQmR1wrA.js";import{r,R as V}from"../../../react/index.js.IuPGg7Py.js";import{E as _,R as k,N as y,D as S,a as N,b as W,c as O,P as $}from"../../../postprocessing/build/index.js.DFkVLnA4.js";import{i as q}from"../../../three-stdlib/misc/WebGL.js.BvFE_U-Q.js";import{u as J,a as K,n as Q}from"../../fiber/dist/index-ba8afaa4.esm.js.CC8UC62r.js";const X=r.createContext(null),j=p=>(p.getAttributes()&O.CONVOLUTION)===O.CONVOLUTION,te=V.memo(r.forwardRef(({children:p,camera:A,scene:L,resolutionScale:l,enabled:E=!0,renderPriority:T=1,autoClear:w=!0,depthBuffer:h,enableNormalPass:v,stencilBuffer:m,multisampling:d=8,frameBufferType:x=U},H)=>{const{gl:o,scene:I,camera:D,size:P}=J(),u=L||I,c=A||D,[e,f,i]=r.useMemo(()=>{const n=q(),a=new _(o,{depthBuffer:h,stencilBuffer:m,multisampling:d>0&&n?d:0,frameBufferType:x});a.addPass(new k(u,c));let s=null,t=null;return v&&(t=new y(u,c),t.enabled=!1,a.addPass(t),l!==void 0&&n&&(s=new S({normalBuffer:t.texture,resolutionScale:l}),s.enabled=!1,a.addPass(s))),[a,t,s]},[c,o,h,m,d,x,u,v,l]);r.useEffect(()=>e==null?void 0:e.setSize(P.width,P.height),[e,P]),K((n,a)=>{if(E){const s=o.autoClear;o.autoClear=w,m&&!w&&o.clearStencil(),e.render(a),o.autoClear=s}},E?T:0);const b=r.useRef(null),g=Q(b);r.useLayoutEffect(()=>{const n=[];if(b.current&&g.current&&e){const a=g.current.objects;for(let s=0;s<a.length;s++){const t=a[s];if(t instanceof N){const R=[t];if(!j(t)){let C=null;for(;(C=a[s+1])instanceof N&&!j(C);)R.push(C),s++}const F=new W(c,...R);n.push(F)}else t instanceof $&&n.push(t)}for(const s of n)e==null||e.addPass(s);f&&(f.enabled=!0),i&&(i.enabled=!0)}return()=>{for(const a of n)e==null||e.removePass(a);f&&(f.enabled=!1),i&&(i.enabled=!1)}},[e,p,c,f,i,g]),r.useEffect(()=>{const n=o.toneMapping;return o.toneMapping=G,()=>{o.toneMapping=n}},[]);const z=r.useMemo(()=>({composer:e,normalPass:f,downSamplingPass:i,resolutionScale:l,camera:c,scene:u}),[e,f,i,l,c,u]);return r.useImperativeHandle(H,()=>e,[e]),M.jsx(X.Provider,{value:z,children:M.jsx("group",{ref:b,children:p})})}));export{X as E,te as a};
